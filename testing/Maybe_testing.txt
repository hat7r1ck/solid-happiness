let
    // =========================================================
    // PART 1: INTERNAL STAFFING ENGINE
    // (Calculates capacity here. No external dependency to break.)
    // =========================================================
    Source_Shifts = Excel.CurrentWorkbook(){[Name="Table1"]}[Content],
    
    // Filter Active & Parse Days
    #"Filtered Active" = Table.SelectRows(Source_Shifts, each ([Status] = "Active")),
    #"Added Mon" = Table.AddColumn(#"Filtered Active", "Monday", each if Text.Contains([Shift Days], "Mon") then [Hours] else 0, type number),
    #"Added Tue" = Table.AddColumn(#"Added Mon", "Tuesday", each if Text.Contains([Shift Days], "Tue") then [Hours] else 0, type number),
    #"Added Wed" = Table.AddColumn(#"Added Tue", "Wednesday", each if Text.Contains([Shift Days], "Wed") then [Hours] else 0, type number),
    #"Added Thu" = Table.AddColumn(#"Added Wed", "Thursday", each if Text.Contains([Shift Days], "Thu") then [Hours] else 0, type number),
    #"Added Fri" = Table.AddColumn(#"Added Thu", "Friday", each if Text.Contains([Shift Days], "Fri") then [Hours] else 0, type number),
    #"Added Sat" = Table.AddColumn(#"Added Fri", "Saturday", each if Text.Contains([Shift Days], "Sat") then [Hours] else 0, type number),
    #"Added Sun" = Table.AddColumn(#"Added Fri", "Sunday", each if Text.Contains([Shift Days], "Sun") then [Hours] else 0, type number),

    // Create Reference Table in Memory
    Staffing_Ref = Table.FromRecords({
        [Day_Name = "Monday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Monday])],
        [Day_Name = "Tuesday",   Total_Capacity_Hours = List.Sum(#"Added Sun"[Tuesday])],
        [Day_Name = "Wednesday", Total_Capacity_Hours = List.Sum(#"Added Sun"[Wednesday])],
        [Day_Name = "Thursday",  Total_Capacity_Hours = List.Sum(#"Added Sun"[Thursday])],
        [Day_Name = "Friday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Friday])],
        [Day_Name = "Saturday",  Total_Capacity_Hours = List.Sum(#"Added Sun"[Saturday])],
        [Day_Name = "Sunday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Sunday])]
    }),

    // =========================================================
    // PART 2: DATA INGESTION & DATE REPAIR
    // =========================================================
    Source_Main = #"Query1", 

    // UNIVERSAL DATE PARSER (Fixes the "Missing Oct-Dec" issue)
    // Reads Text, Date objects, or Excel Serial Numbers automatically.
    #"Added Master Date" = Table.AddColumn(Source_Main, "Master_Date", each 
        let
            raw = [#"Created Date/Time (UTC)"],
            attempt1 = try Date.From(raw) otherwise null,
            attempt2 = if attempt1 = null then try Date.From(Number.From(raw)) otherwise null else attempt1
        in
            attempt2, type date),

    // SPLUNK LINE GENERATOR
    // marks everything after Sept 1 as "Splunk" so you can show the line in the chart.
    #"Added System Era" = Table.AddColumn(#"Added Master Date", "System_Era", each 
        if [Master_Date] >= #date(2025, 9, 1) then "Splunk (New)" else "Chronicle (Legacy)", type text),

    // Add Day Name for Staffing Link
    #"Added Day Name" = Table.AddColumn(#"Added System Era", "Day_Name", each 
        if [Master_Date] <> null then Date.DayOfWeekName([Master_Date]) else "Unknown", type text),

    // =========================================================
    // PART 3: METRICS & MERGE
    // =========================================================
    
    // Calculate Speed Metrics
    #"Calc MTTA" = Table.AddColumn(#"Added Day Name", "MTTA_Minutes", each try Number.From([#"Mean time to Acknowledge"]) * 1440 otherwise null, type number),
    #"Calc MTTP" = Table.AddColumn(#"Calc MTTA", "MTTP_Minutes", each try Number.From([#"Mean time to Close"]) * 1440 otherwise null, type number),
    
    // Merge Staffing (Internal Join - No Firewall Error)
    #"Merged Staffing" = Table.NestedJoin(#"Calc MTTP", {"Day_Name"}, Staffing_Ref, {"Day_Name"}, "StaffInfo", JoinKind.LeftOuter),
    #"Expanded Staffing" = Table.ExpandTableColumn(#"Merged Staffing", "StaffInfo", {"Total_Capacity_Hours"}),

    // =========================================================
    // PART 4: AGGREGATION
    // =========================================================

    // Group by Date AND System Era (To allow the chart split)
    #"Grouped Daily" = Table.Group(#"Expanded Staffing", {"Master_Date", "System_Era"}, {
        {"Daily_Volume", each Table.RowCount(_), Int64.Type},
        {"Daily_Avg_MTTP", each List.Average([MTTP_Minutes]), type number},
        {"Daily_Capacity_Hours", each List.Max([Total_Capacity_Hours]), type number}
    }),

    // Utilization & Kingman Math
    #"Calc Utilization" = Table.AddColumn(#"Grouped Daily", "Daily_Utilization", each if [Daily_Capacity_Hours] > 0 then ([Daily_Volume] * ([Daily_Avg_MTTP]/60)) / [Daily_Capacity_Hours] else 0, type number),
    #"Calc Kingman" = Table.AddColumn(#"Calc Utilization", "Kingman_Factor", each if [Daily_Utilization] >= 1 then 100 else [Daily_Utilization] / (1 - [Daily_Utilization]), type number),
    
    // Final Clean
    #"Replaced Errors" = Table.ReplaceErrorValues(#"Calc Kingman", List.Transform(Table.ColumnNames(#"Calc Kingman"), each {_, 0}))
in
    #"Replaced Errors"

