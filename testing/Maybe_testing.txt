let
    // CONFIG
    SourcePath = "C:\Users\Morgan\Downloads\Raw_Data",
    Source = Folder.Files(SourcePath),

    // 1. FILTER
    #"Filtered Rows" = Table.SelectRows(Source, each ([Extension] = ".xlsx") and not Text.StartsWith([Name], "~$")),

    // --- FUNCTION DEFINITION ---
    GetBestSheet = (BinaryContent) =>
        let
            WorkbookContent = Excel.Workbook(BinaryContent),
            OnlySheets = Table.SelectRows(WorkbookContent, each [Kind] = "Sheet"),
            
            // FILTER JUNK
            CleanSheets = Table.SelectRows(OnlySheets, each 
                not List.Contains({"Summary", "Notes", "Instructions", "Cover"}, [Name]) 
                and not Text.StartsWith([Name], "U#")
            ),
            
            // SORT BY NAME LENGTH
            Sorted = Table.Sort(CleanSheets, {{"Name", Order.Descending}}),
            
            // GRAB TOP SHEET
            TargetSheetRecord = if Table.IsEmpty(Sorted) then [Data=null, Name="ERROR"] else Sorted{0},
            TargetSheetData = TargetSheetRecord[Data],
            
            // PROMOTE HEADERS (Strictly 1 argument for compatibility)
            PromoteHeaders = Table.PromoteHeaders(TargetSheetData),
            
            // ADD SOURCE NAME
            AddSourceMeta = Table.AddColumn(PromoteHeaders, "Source_Tab_Used", each TargetSheetRecord[Name])
        in
            AddSourceMeta,

    // 2. INVOKE FUNCTION
    #"Added Custom" = Table.AddColumn(#"Filtered Rows", "CustomContent", each GetBestSheet([Content])),
    
    // 3. EXPAND
    AllColumnNames = List.Distinct(List.Combine(List.Transform(#"Added Custom"[CustomContent], each Table.ColumnNames(_)))),
    #"Expanded CustomContent" = Table.ExpandTableColumn(#"Added Custom", "CustomContent", AllColumnNames),

    // 4. RENAME (Strictly 2 arguments - removed the 3rd argument causing the crash)
    #"Renamed Columns" = Table.RenameColumns(#"Expanded CustomContent",{
        {"Time to Ack", "MTTA"}, {"Time to Process", "MTTP"}, 
        {"Alert Count", "Volume"}, {"Total Cases", "Volume"},
        {"Tier", "Tier"},
        {"Occurred Date (UTC)", "Date_P1"}, {"Occurrd Date (UTC)", "Date_P1"}, 
        {"Created (UTC)", "Date_P1"}, {"Timestamp", "Date_P1"},
        {"Created Time (ET)", "Date_P2"}, {"Created", "Date_P2"}, {"Log Date", "Date_P2"}
    }),

    // 5. COALESCE DATES
    #"Added Master Date" = Table.AddColumn(#"Renamed Columns", "Raw_Date_String", each 
        if [Date_P1] <> null then [Date_P1] 
        else if [Date_P2] <> null then [Date_P2] 
        else null),

    // 6. DATE FIX
    #"Fix Date Format" = Table.TransformColumns(#"Added Master Date",{
        {"Raw_Date_String", each 
            if Value.Is(_, type date) then _ 
            else if Value.Is(_, type datetime) then DateTime.Date(_)
            else if Value.Is(_, type number) then Date.From(_) 
            else 
                let
                    str = Text.From(_),
                    cleanStr = Text.SplitAny(Text.Replace(str, "T", " "), " "){0},
                    val = try Date.From(cleanStr) otherwise null
                in
                    val,
            type date}
    }),

    // 7. CLEANUP
    #"Renamed Final Date" = Table.RenameColumns(#"Fix Date Format", {{"Raw_Date_String", "Date"}}),
    #"Filtered Rows1" = Table.SelectRows(#"Renamed Final Date", each [Date] <> null),
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows1"),
    
    // 8. FINAL TYPES (Strictly 2 arguments)
    #"Selected Columns" = Table.SelectColumns(#"Removed Duplicates", {"Date", "Volume", "MTTA", "MTTP", "Tier", "Staffing"}),
    
    #"Final Types" = Table.TransformColumnTypes(#"Selected Columns",{
        {"Volume", Int64.Type}, {"MTTA", type number}, {"MTTP", type number}, {"Staffing", Int64.Type}
    })
in
    #"Final Types"

