let
    // =========================================================
    // PART 1: INTERNAL STAFFING LOGIC (No External Dependencies)
    // =========================================================
    
    // [CHECK 1] Change "Table1" to the name of the table on your 'Shift' tab
    Source_Shifts = Excel.CurrentWorkbook(){[Name="Table1"]}[Content],
    
    // Process Shift Table
    #"Filtered Active" = Table.SelectRows(Source_Shifts, each ([Status] = "Active")),
    #"Added Mon" = Table.AddColumn(#"Filtered Active", "Monday", each if Text.Contains([Shift Days], "Mon") then [Hours] else 0, type number),
    #"Added Tue" = Table.AddColumn(#"Added Mon", "Tuesday", each if Text.Contains([Shift Days], "Tue") then [Hours] else 0, type number),
    #"Added Wed" = Table.AddColumn(#"Added Tue", "Wednesday", each if Text.Contains([Shift Days], "Wed") then [Hours] else 0, type number),
    #"Added Thu" = Table.AddColumn(#"Added Wed", "Thursday", each if Text.Contains([Shift Days], "Thu") then [Hours] else 0, type number),
    #"Added Fri" = Table.AddColumn(#"Added Thu", "Friday", each if Text.Contains([Shift Days], "Fri") then [Hours] else 0, type number),
    #"Added Sat" = Table.AddColumn(#"Added Fri", "Saturday", each if Text.Contains([Shift Days], "Sat") then [Hours] else 0, type number),
    #"Added Sun" = Table.AddColumn(#"Added Fri", "Sunday", each if Text.Contains([Shift Days], "Sun") then [Hours] else 0, type number),

    // Create Internal Staffing Table
    Staffing_Data = Table.FromRecords({
        [Day_Name = "Monday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Monday])],
        [Day_Name = "Tuesday",   Total_Capacity_Hours = List.Sum(#"Added Sun"[Tuesday])],
        [Day_Name = "Wednesday", Total_Capacity_Hours = List.Sum(#"Added Sun"[Wednesday])],
        [Day_Name = "Thursday",  Total_Capacity_Hours = List.Sum(#"Added Sun"[Thursday])],
        [Day_Name = "Friday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Friday])],
        [Day_Name = "Saturday",  Total_Capacity_Hours = List.Sum(#"Added Sun"[Saturday])],
        [Day_Name = "Sunday",    Total_Capacity_Hours = List.Sum(#"Added Sun"[Sunday])]
    }),

    // =========================================================
    // PART 2: MAIN DATA & UNIVERSAL DATE FIX
    // =========================================================
    
    // [CHECK 2] Ensure this matches your main data query name
    Source_Main = #"Query1", 

    // THE FIX: Universal Date Parsing (Handles Text, Date, and Serial Numbers)
    #"Added Master Date" = Table.AddColumn(Source_Main, "Master_Date", each 
        let
            raw = [#"Created Date/Time (UTC)"],
            // Attempt 1: Standard Date conversion
            attempt1 = try Date.From(raw) otherwise null,
            // Attempt 2: Handle Excel Serial Numbers (e.g. 45900)
            attempt2 = if attempt1 = null then try Date.From(Number.From(raw)) otherwise null else attempt1
        in
            attempt2, type date),

    // Add Day Name for linking
    #"Added Day Name" = Table.AddColumn(#"Added Master Date", "Day_Name", each 
        if [Master_Date] <> null then Date.DayOfWeekName([Master_Date]) else "Unknown", type text),

    // Metrics
    #"Calc MTTA" = Table.AddColumn(#"Added Day Name", "MTTA_Minutes", each try Number.From([#"Mean time to Acknowledge"]) * 1440 otherwise null, type number),
    #"Calc MTTP" = Table.AddColumn(#"Calc MTTA", "MTTP_Minutes", each try Number.From([#"Mean time to Close"]) * 1440 otherwise null, type number),
    #"Calc Remediation" = Table.AddColumn(#"Calc MTTP", "Remediation_Minutes", each try Duration.TotalMinutes([#"Remediation Time (UTC)"] - [#"Created Date/Time (UTC)"]) otherwise null, type number),
    #"Calc Complexity" = Table.AddColumn(#"Calc Remediation", "Is_Complex", each if [Escalation] <> null and [Escalation] <> "" then "Complex" else "Standard", type text),
    #"Calc Hour" = Table.AddColumn(#"Calc Complexity", "Hour_Created", each try Time.Hour([#"Created Date/Time (UTC)"]) otherwise 0, Int64.Type),

    // =========================================================
    // PART 3: THE MERGE (INTERNAL)
    // =========================================================

    // Merging the internal 'Staffing_Data' variable from Part 1. 
    // No external query required.
    #"Merged Staffing" = Table.NestedJoin(#"Calc Hour", {"Day_Name"}, Staffing_Data, {"Day_Name"}, "StaffInfo", JoinKind.LeftOuter),
    #"Expanded Staffing" = Table.ExpandTableColumn(#"Merged Staffing", "StaffInfo", {"Total_Capacity_Hours"}),

    // Group & Finalize
    #"Grouped Daily" = Table.Group(#"Expanded Staffing", {"Master_Date"}, {
        {"Daily_Volume", each Table.RowCount(_), Int64.Type},
        {"Daily_Avg_MTTP", each List.Average([MTTP_Minutes]), type number},
        {"Daily_Capacity_Hours", each List.Max([Total_Capacity_Hours]), type number}
    }),

    #"Calc Utilization" = Table.AddColumn(#"Grouped Daily", "Daily_Utilization", each if [Daily_Capacity_Hours] > 0 then ([Daily_Volume] * ([Daily_Avg_MTTP]/60)) / [Daily_Capacity_Hours] else 0, type number),
    #"Calc Kingman" = Table.AddColumn(#"Calc Utilization", "Kingman_Factor", each if [Daily_Utilization] >= 1 then 100 else [Daily_Utilization] / (1 - [Daily_Utilization]), type number),

    #"Merged Queries" = Table.NestedJoin(#"Expanded Staffing", {"Master_Date"}, #"Calc Kingman", {"Master_Date"}, "DailyStats", JoinKind.LeftOuter),
    #"Expanded DailyStats" = Table.ExpandTableColumn(#"Merged Queries", "DailyStats", {"Daily_Volume", "Daily_Utilization", "Kingman_Factor"}),
    #"Replaced Errors" = Table.ReplaceErrorValues(#"Expanded DailyStats", List.Transform(Table.ColumnNames(#"Expanded DailyStats"), each {_, null}))
in
    #"Replaced Errors"

