let
    // 1. POINTER TO YOUR HARD WORK
    // Make sure "Query1" is the name of your cleaning query
    Source = #"Query1",

    // ==============================================================
    // [FIX] CREATE THE MISSING MASTER_DATE COLUMN
    // ==============================================================
    #"Added Master Date" = Table.AddColumn(Source, "Master_Date", each 
        try DateTime.Date([#"Created Date/Time (UTC)"]) otherwise null, type date),

    // ==============================================================
    // NOW THE REST OF THE MATH WILL WORK
    // ==============================================================
    
    // A. MTTA (Minutes) - The "1899" & Error Handler
    #"Calc MTTA" = Table.AddColumn(#"Added Master Date", "MTTA_Minutes", each 
        try Number.From([#"Mean time to Acknowledge"]) * 1440 otherwise null, type number),

    // B. MTTP (Minutes)
    #"Calc MTTP" = Table.AddColumn(#"Calc MTTA", "MTTP_Minutes", each 
        try Number.From([#"Mean time to Close"]) * 1440 otherwise null, type number),

    // C. Remediation (End - Start)
    #"Calc Remediation" = Table.AddColumn(#"Calc MTTP", "Remediation_Minutes", each 
        try Duration.TotalMinutes([#"Remediation Time (UTC)"] - [#"Created Date/Time (UTC)"]) otherwise null, type number),

    // D. Complexity Flag (For Overlays)
    #"Calc Complexity" = Table.AddColumn(#"Calc Remediation", "Is_Complex", each 
        if [Escalation] <> null and [Escalation] <> "" then "Complex" else "Standard", type text),

    // E. Heat Map Helpers (Day & Hour)
    #"Calc DayName" = Table.AddColumn(#"Calc Complexity", "Day_Name", each Date.DayOfWeekName([#"Created Date/Time (UTC)"]), type text),
    #"Calc Hour" = Table.AddColumn(#"Calc DayName", "Hour_Created", each Time.Hour([#"Created Date/Time (UTC)"]), Int64.Type),

    // ==============================================================
    // LEADERSHIP STATS (Daily Aggregation)
    // ==============================================================
    #"Grouped Daily" = Table.Group(#"Calc Hour", {"Master_Date"}, {
        {"Daily_Volume", each Table.RowCount(_), Int64.Type},
        // Change "name" below to "Analyst Name" or whatever your user column is called if this errors
        {"Daily_Staff", each List.Count(List.Distinct([name])), Int64.Type}, 
        {"Daily_Avg_MTTP", each List.Average([MTTP_Minutes]), type number}
    }),

    // Utilization Calculation
    #"Calc Utilization" = Table.AddColumn(#"Grouped Daily", "Daily_Utilization", each 
        if [Daily_Staff] > 0 then ([Daily_Volume] * [Daily_Avg_MTTP]) / ([Daily_Staff] * 480) else 0, type number),

    // Kingman Calculation
    #"Calc Kingman" = Table.AddColumn(#"Calc Utilization", "Kingman_Factor", each 
        if [Daily_Utilization] >= 1 then 100 else [Daily_Utilization] / (1 - [Daily_Utilization]), type number),

    // ==============================================================
    // MERGE BACK & FINALIZE
    // ==============================================================
    #"Merged Queries" = Table.NestedJoin(#"Calc Hour", {"Master_Date"}, #"Calc Kingman", {"Master_Date"}, "DailyStats", JoinKind.LeftOuter),
    #"Expanded DailyStats" = Table.ExpandTableColumn(#"Merged Queries", "DailyStats", {"Daily_Volume", "Daily_Utilization", "Kingman_Factor"}),
    
    // Final Error Sweep
    #"Replaced Errors" = Table.ReplaceErrorValues(#"Expanded DailyStats", List.Transform(Table.ColumnNames(#"Expanded DailyStats"), each {_, null}))
in
    #"Replaced Errors"

