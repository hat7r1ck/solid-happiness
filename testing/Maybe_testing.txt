let
    SourcePath = "C:\Users\k111609\Downloads\Raw_Data",
    Source = Folder.Files(SourcePath),
    #"Filtered Files" = Table.SelectRows(Source, each ([Extension] = ".xlsx") and not Text.StartsWith([Name], "~$")),
    
    // Grab the best sheet (Complete Data > Data > Last Sheet)
    GetData = (BinaryContent) =>
        let
            Workbook = Excel.Workbook(BinaryContent),
            Sheet = if Table.Contains(Workbook, [Name="Complete Data"]) then Workbook{[Name="Complete Data"]}[Data] 
                    else if Table.Contains(Workbook, [Name="Data"]) then Workbook{[Name="Data"]}[Data]
                    else Table.Last(Table.SelectRows(Workbook, each [Kind]="Sheet"))[Data],
            Headers = Table.PromoteHeaders(Sheet)
        in
            Headers,

    #"Added Custom" = Table.AddColumn(#"Filtered Files", "ContentData", each GetData([Content])),
    #"Combined Tables" = Table.Combine(#"Added Custom"[ContentData]),
    
    // DYNAMIC RENAMER (Fixes the capitalization mismatch in your screenshots)
    ColNames = Table.ColumnNames(#"Combined Tables"),
    DateCol = List.First(List.Select(ColNames, each Text.Contains(_, "Occurred Date") or Text.Contains(_, "Created Date"))),
    // Finds 'Mean time' OR 'Mean Time' (Case Insensitive)
    DurCol = List.First(List.Select(ColNames, each Text.Contains(_, "Mean time to Remediate", Comparer.OrdinalIgnoreCase))),

    #"Renamed Columns" = Table.RenameColumns(#"Combined Tables", {
        {DateCol, "Raw_Date"},
        {DurCol, "Raw_MTTR"} // This is the 1899 column
    })
in
    #"Renamed Columns"


let
    // 1. STAFFING LOAD (Case-Insensitive Fix)
    Source_Shifts = Excel.CurrentWorkbook(){[Name="Table1"]}[Content],
    #"Active Staff" = Table.SelectRows(Source_Shifts, each ([Status] = "Active")),
    
    // Helper: Checks for day name ignoring Case (Mon = mon = MON)
    CheckDay = (shiftString, dayToFind) => 
        if shiftString = null then 0 
        else if Text.Contains(shiftString, dayToFind, Comparer.OrdinalIgnoreCase) then 1 
        else 0,

    Staffing_Ref = Table.FromRecords({
        [Day_Name = "Monday",    Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Mon"))[X])],
        [Day_Name = "Tuesday",   Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Tue"))[X])],
        [Day_Name = "Wednesday", Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Wed"))[X])],
        [Day_Name = "Thursday",  Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Thu"))[X])],
        [Day_Name = "Friday",    Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Fri"))[X])],
        [Day_Name = "Saturday",  Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Sat"))[X])],
        [Day_Name = "Sunday",    Cap = List.Sum(Table.AddColumn(#"Active Staff", "X", each [Hours] * CheckDay([Shift Days], "Sun"))[X])]
    }),

    // 2. DATA LOAD & DATE FIX
    Source_Main = Alert_Pull,

    #"Parsed Dates" = Table.AddColumn(Source_Main, "Master_Date", each 
        let 
            val = [Raw_Date],
            a1 = try Date.From(val) otherwise null,
            a2 = if a1 = null then try Date.From(Number.From(val)) otherwise null else a1
        in if a2 = null then #date(1900, 1, 1) else a2, type date),

    // Clean Day Name (Proper Case)
    #"Added DayName" = Table.AddColumn(#"Parsed Dates", "Day_Name", each 
        if [Master_Date] = #date(1900, 1, 1) then "Unknown" 
        else Text.Proper(Text.Trim(Date.DayOfWeekName([Master_Date]))), type text),
        
    #"Added Era" = Table.AddColumn(#"Added DayName", "System_Era", each if [Master_Date] >= #date(2025, 9, 1) then "Splunk" else "Chronicle"),

    // 3. THE 1899 FIX (No Subtraction)
    #"Calc MTTR" = Table.AddColumn(#"Added Era", "MTTR_Mins", each 
        let 
            rawVal = [Raw_MTTR],
            // Direct conversion: 1899 timestamp -> Decimal Number -> Minutes
            mins = try Number.From(rawVal) * 1440 otherwise 0
        in mins, type number),

    // 4. MERGE & AGGREGATE
    #"Merged Staff" = Table.NestedJoin(#"Calc MTTR", {"Day_Name"}, Staffing_Ref, {"Day_Name"}, "StaffInfo", JoinKind.LeftOuter),
    #"Expanded Staff" = Table.ExpandTableColumn(#"Merged Staff", "StaffInfo", {"Cap"}),

    #"Daily Group" = Table.Group(#"Expanded Staff", {"Master_Date", "System_Era"}, {
        {"Daily_Volume", each Table.RowCount(_), Int64.Type},
        {"Avg_MTTR", each List.Average([MTTR_Mins]), type number},
        {"Staff_Capacity", each List.Max([Cap]), type number}
    }),

    // 5. Final Math (Safe Division)
    #"Utilization" = Table.AddColumn(#"Daily Group", "Util", each 
        if [Staff_Capacity] <> null and [Staff_Capacity] > 0 
        then ([Daily_Volume] * ([Avg_MTTR]/60)) / [Staff_Capacity] 
        else 0, type number),
    
    #"Kingman" = Table.AddColumn(#"Utilization", "Kingman", each 
        if [Util] >= 0.98 then 100 
        else if [Util] <= 0 then 0 
        else [Util] / (1 - [Util]), type number),
        
    #"Clean Output" = Table.ReplaceErrorValues(#"Kingman", List.Transform(Table.ColumnNames(#"Kingman"), each {_, 0}))
in
    #"Clean Output"
