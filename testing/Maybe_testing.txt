
1. The Power Query Script (dashboard_logic.pq)

let
    // ==============================================================
    // STEP 1: LOAD YOUR MANUAL WORK
    // IMPORTANT: Change "Query1" to the exact name of your current cleaning query
    // ==============================================================
    Source = #"Query1",

    // ==============================================================
    // STEP 2: SAFETY CHECKS & FORMATTING
    // ==============================================================
    #"Ensured Date Type" = Table.TransformColumnTypes(Source,{{"Master_Date", type date}}),

    // ==============================================================
    // STEP 3: CALCULATE PERFORMANCE METRICS (ROW LEVEL)
    // ==============================================================
    
    // A. MTTA (Minutes) - Handles "1899" Excel Duration Bug
    #"Calc MTTA" = Table.AddColumn(#"Ensured Date Type", "MTTA_Minutes", each 
        try Number.From([#"Mean time to Acknowledge"]) * 1440 otherwise null, type number),

    // B. MTTP (Minutes) - Handles "1899" Excel Duration Bug
    #"Calc MTTP" = Table.AddColumn(#"Calc MTTA", "MTTP_Minutes", each 
        try Number.From([#"Mean time to Close"]) * 1440 otherwise null, type number),

    // C. Remediation (Minutes) - Calculates Duration (End - Start) to bypass text garbage
    #"Calc Remediation" = Table.AddColumn(#"Calc MTTP", "Remediation_Minutes", each 
        try Duration.TotalMinutes([#"Remediation Time (UTC)"] - [#"Created Date/Time (UTC)"]) otherwise null, type number),

    // D. Complexity Flag - For "Morgan's Vision" Dashboard Overlays
    #"Calc Complexity" = Table.AddColumn(#"Calc Remediation", "Is_Complex", each 
        if [Escalation] <> null and [Escalation] <> "" then "Complex" else "Standard", type text),

    // E. Heat Map Helpers - Extracts Day and Hour for Burnout Analysis
    #"Calc DayName" = Table.AddColumn(#"Calc Complexity", "Day_Name", each Date.DayOfWeekName([#"Created Date/Time (UTC)"]), type text),
    #"Calc Hour" = Table.AddColumn(#"Calc DayName", "Hour_Created", each Time.Hour([#"Created Date/Time (UTC)"]), Int64.Type),

    // ==============================================================
    // STEP 4: GENERATE LEADERSHIP STATS (DAILY AGGREGATION)
    // ==============================================================
    #"Grouped Daily" = Table.Group(#"Calc Hour", {"Master_Date"}, {
        {"Daily_Volume", each Table.RowCount(_), Int64.Type},
        {"Daily_Staff", each List.Count(List.Distinct([name])), Int64.Type}, 
        {"Daily_Avg_MTTP", each List.Average([MTTP_Minutes]), type number}
    }),

    // F. Utilization (Rho) - The "Burnout" Metric
    // Formula: (Volume * Avg Service Time) / (Staff * 480 Mins)
    #"Calc Utilization" = Table.AddColumn(#"Grouped Daily", "Daily_Utilization", each 
        if [Daily_Staff] > 0 then ([Daily_Volume] * [Daily_Avg_MTTP]) / ([Daily_Staff] * 480) else 0, type number),

    // G. Kingman Factor - The "Crash Point" Predictor
    // Formula: Utilization / (1 - Utilization)
    #"Calc Kingman" = Table.AddColumn(#"Calc Utilization", "Kingman_Factor", each 
        if [Daily_Utilization] >= 1 then 100 else [Daily_Utilization] / (1 - [Daily_Utilization]), type number),

    // ==============================================================
    // STEP 5: MERGE & FINALIZE
    // ==============================================================
    #"Merged Queries" = Table.NestedJoin(#"Calc Hour", {"Master_Date"}, #"Calc Kingman", {"Master_Date"}, "DailyStats", JoinKind.LeftOuter),
    #"Expanded DailyStats" = Table.ExpandTableColumn(#"Merged Queries", "DailyStats", {"Daily_Volume", "Daily_Utilization", "Kingman_Factor"}),
    
    // Final Error Sweep (Replaces any calculation crashes with nulls)
    #"Replaced Errors" = Table.ReplaceErrorValues(#"Expanded DailyStats", List.Transform(Table.ColumnNames(#"Expanded DailyStats"), each {_, null}))
in
    #"Replaced Errors"

2. The Math Documentation (FORMULAS.md)
Save this file to Git. Open this on your second screen during the meeting to answer "How did you calculate this?"
# SOC Metric Logic & Definitions

## 1. Kingman's Factor (Wait Time Predictor)
**Purpose:** Mathematical proof of why wait times explode when Utilization > 80%.
**Formula:** `Utilization / (1 - Utilization)`
* **The Insight:** Wait times do not rise linearly. They curve exponentially.
* **Target:** Keep Kingman Factor < 4 (approx 80% utilization).

## 2. Analyst Utilization Rate
**Purpose:** Primary indicator of burnout and capacity risk.
**Formula:** > `(Daily Alert Volume * Average MTTP) / (Active Staff Count * 480 Minutes)`
* *Note:* Assumes an 8-hour shift (480 mins) per active staff member.

## 3. MTTA (Mean Time to Acknowledge)
**Calculation Method:** * Extracted from "1899" Excel Datetime format.
* **Logic:** `Value * 1440` (Converts fractional day to total minutes).
* **Validation:** Verified against manual spot checks of raw timestamps.

## 4. Remediation Time (MTTR)
**Calculation Method:**
* **Logic:** `[Remediation Time] - [Created Time]`
* **Correction:** Bypasses corrupted "Ended: 4h" text fields in source data to ensure mathematical accuracy for regression analysis.

## 5. Case Complexity
**Logic:**
* IF `[Escalation]` field is populated → **Complex**
* IF `[Escalation]` field is null/empty → **Standard**

3. The Repository Readme (README.md)
Save this to make the repo look professional immediately.
# SOC Capacity & Performance Dashboard

## Project Overview
Automated ETL pipeline and visualization suite for Security Operations Center (SOC) metrics. 
Transforms raw ITSM/SIEM exports into actionable leadership insights regarding staffing capacity, burnout risk, and SLA adherence.

## Key Features
* **Kingman Curve Analysis:** Visualizes the exponential relationship between Analyst Utilization and MTTA.
* **Automated Cleaning:** Bypasses legacy data corruption (1899 Date errors, text fields).
* **Burnout Heat Maps:** Identifies high-volume windows by Hour/Day.
* **Dynamic Overlays:** "Single Pane" dashboard with selectable complexity and volume toggles.

## Technical Implementation
* **Language:** Power Query M
* **Logic:** `dashboard_logic.pq` (Appends math to cleaned data)
* **Math:** See `FORMULAS.md` for queuing theory implementation.

