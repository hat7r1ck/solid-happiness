let
    // CONFIG
    SourcePath = "C:\Users\Morgan\Downloads\Raw_Data",
    Source = Folder.Files(SourcePath),

    // 1. FILTER
    #"Filtered Rows" = Table.SelectRows(Source, each ([Extension] = ".xlsx") and not Text.StartsWith([Name], "~$")),

    // --- "TAB HUNTER" FUNCTION (With U# Protection) ---
    GetBestSheet = (BinaryContent) =>
        let
            WorkbookContent = Excel.Workbook(BinaryContent),
            OnlySheets = Table.SelectRows(WorkbookContent, each [Kind] = "Sheet"),
            
            // LEVEL 1: Aggressive Junk Removal
            // Removes "Summary", "Notes", and the "U#" tabs you found
            CleanSheets = Table.SelectRows(OnlySheets, each 
                not List.Contains({"Summary", "Notes", "Instructions", "Cover"}, [Name]) 
                and not Text.StartsWith([Name], "U#") 
                and not (Text.StartsWith([Name], "U") and Text.Length([Name]) < 4) // Catches U1, U12
            ),
            
            // LEVEL 2: Hunter Tactics (Look for Good Keywords)
            Hunter1 = Table.SelectRows(CleanSheets, each Text.Contains([Name], "Complete Data", Comparer.OrdinalIgnoreCase)),
            Hunter2 = Table.SelectRows(CleanSheets, each Text.Contains([Name], "New Data", Comparer.OrdinalIgnoreCase)),
            Hunter3 = Table.SelectRows(CleanSheets, each Text.Contains([Name], "Data", Comparer.OrdinalIgnoreCase)),
            
            // LEVEL 3: Decision
            BestList = if not Table.IsEmpty(Hunter1) then Hunter1 
                       else if not Table.IsEmpty(Hunter2) then Hunter2 
                       else if not Table.IsEmpty(Hunter3) then Hunter3
                       else CleanSheets, // Fallback to whatever is left
            
            // LEVEL 4: The Final Tie-Breaker (Longest Name Wins)
            // If we are left with "Sheet1" and "Security_Export_Final", this picks the Export.
            SortedByLength = Table.Sort(BestList, each Text.Length([Name]), Order.Descending),
            TargetSheetRecord = if Table.IsEmpty(SortedByLength) then [Data=null, Name="ERROR_NO_SHEETS"] else SortedByLength{0},
            
            TargetSheetData = TargetSheetRecord[Data],
            PromoteHeaders = Table.PromoteHeaders(TargetSheetData, [PromoteAllScalars=true]),
            AddSourceMeta = Table.AddColumn(PromoteHeaders, "Source_Tab_Used", each TargetSheetRecord[Name])
        in
            AddSourceMeta,

    #"Added Custom" = Table.AddColumn(#"Filtered Rows", "CustomContent", each GetBestSheet([Content])),
    
    // --- EXPAND ALL COLUMNS ---
    AllColumnNames = List.Distinct(List.Combine(List.Transform(#"Added Custom"[CustomContent], each Table.ColumnNames(_)))),
    #"Expanded CustomContent" = Table.ExpandTableColumn(#"Added Custom", "CustomContent", AllColumnNames),

    // 2. SAFE RENAMING
    #"Renamed Columns" = Table.RenameColumns(#"Expanded CustomContent",{
        {"Time to Ack", "MTTA"}, {"Time to Process", "MTTP"}, 
        {"Alert Count", "Volume"}, {"Total Cases", "Volume"},
        {"Tier", "Tier"},
        // Date Variants
        {"Occurred Date (UTC)", "Date_P1"}, {"Occurrd Date (UTC)", "Date_P1"}, 
        {"Created (UTC)", "Date_P1"}, {"Timestamp", "Date_P1"},
        {"Created Time (ET)", "Date_P2"}, {"Created", "Date_P2"}, {"Log Date", "Date_P2"}
    }, MissingField.Ignore),

    // 3. COALESCE DATES
    #"Added Master Date" = Table.AddColumn(#"Renamed Columns", "Raw_Date_String", each 
        if [Date_P1] <> null then [Date_P1] 
        else if [Date_P2] <> null then [Date_P2] 
        else null),

    // 4. TITANIUM DATE PARSING
    #"Fix Date Format" = Table.TransformColumns(#"Added Master Date",{
        {"Raw_Date_String", each 
            if Value.Is(_, type date) then _ 
            else if Value.Is(_, type datetime) then DateTime.Date(_)
            else if Value.Is(_, type number) then Date.From(_) 
            else 
                let
                    str = Text.From(_),
                    cleanStr = Text.SplitAny(Text.Replace(str, "T", " "), " "){0},
                    attempt1 = try Date.From(cleanStr) otherwise null,
                    attempt2 = try Date.From(cleanStr, "en-GB") otherwise null
                in
                    if attempt1 <> null then attempt1 
                    else if attempt2 <> null then attempt2
                    else null,
            type date}
    }),

    // 5. CLEANUP
    #"Renamed Final Date" = Table.RenameColumns(#"Fix Date Format", {{"Raw_Date_String", "Date"}}),
    #"Filtered Rows1" = Table.SelectRows(#"Renamed Final Date", each [Date] <> null),
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows1"),
    
    #"Selected Columns" = Table.SelectColumns(#"Removed Duplicates", {"Date", "Volume", "MTTA", "MTTP", "Tier", "Staffing"}),
    
    #"Final Types" = Table.TransformColumnTypes(#"Selected Columns",{
        {"Volume", Int64.Type}, {"MTTA", type number}, {"MTTP", type number}, {"Staffing", Int64.Type}
    })
in
    #"Final Types"
