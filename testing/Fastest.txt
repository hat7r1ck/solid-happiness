| where isnotnull(_m_user) AND _m_user != ""
| stats
    dc(_m_host) as host_count
    dc(_m_ip)   as ip_count
    values(_m_host) as hosts
    values(_m_ip)   as ips
    values(rule_title) as rules
    by _m_user

| eval hosts = mvjoin(mvindex(mvsort(hosts),0,4), ", ")
| eval ips   = mvjoin(mvindex(mvsort(ips),0,4), ", ")
| eval rules = mvjoin(mvindex(mvsort(rules),0,4), ", ")

| sort -host_count -ip_count

| rename _m_user as "User",
         host_count as "Distinct Hosts",
         ip_count   as "Distinct IPs"

| fields "User" "Distinct Hosts" "Distinct IPs" hosts ips rules



| where isnotnull(_m_host) AND _m_host != ""
| stats
    dc(_m_user) as user_count
    dc(_m_ip)   as ip_count
    values(_m_user) as users
    values(_m_ip)   as ips
    values(rule_title) as rules
    by _m_host

| eval users = mvjoin(mvindex(mvsort(users),0,4), ", ")
| eval ips   = mvjoin(mvindex(mvsort(ips),0,4), ", ")
| eval rules = mvjoin(mvindex(mvsort(rules),0,4), ", ")

| sort -user_count -ip_count

| rename _m_host as "Host",
         user_count as "Distinct Users",
         ip_count   as "Distinct IPs"

| fields "Host" "Distinct Users" "Distinct IPs" users ips rules




| eval _m_user = lower(coalesce(
    user,
    src_user,
    dest_user,
    identity,
    user_name,
    user_normalized
))

| eval _m_host = lower(coalesce(
    host,
    hostname,
    dest,
    dvc,
    dest_nt_host,
    src_nt_host,
    ComputerName,
    `alert.target.hostname`
))

| eval _m_ip = coalesce(
    src,
    src_ip,
    dest,
    dest_ip,
    dvc_ip
)

| eval _m_mail = lower(coalesce(
    user_email,
    src_user_email,
    dest_user_email,
    recipient,
    sender
))

| eval _m_dom = lower(coalesce(
    url_domain,
    dest_dns,
    domain,
    query
))

| eval _m_url = lower(coalesce(
    url,
    uri,
    uri_path,
    request
))

| eval _m_hash = lower(coalesce(
    file_hash,
    sha256,
    sha1,
    md5
))

| eval _m_risk = lower(coalesce(
    risk_object,
    normalized_risk_object
))
