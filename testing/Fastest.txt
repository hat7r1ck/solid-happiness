ggghh
| from datamodel:"Risk.All_Risk"
| eval source = search_name
| lookup RIR-Deduplicate.csv risk_object source OUTPUT alert
| fillnull value="unknown" alert

| eval _entity = trim(lower("$tok_entity$"))
| where len(_entity) > 0

| eval _m_user = lower(coalesce(
    user,
    src_user,
    dest_user,
    identity,
    user_name,
    user_normalized,
    user_email
))
| eval _m_mail = lower(user_email)
| eval _m_host = lower(coalesce(
    host,
    hostname,
    dest,
    dvc,
    dest_nt_host,
    src_nt_host,
    ComputerName
))
| eval _m_risk = lower(risk_object)

| eval norm_user = case(
    like(_entity,"%@%"), coalesce(_m_mail,_m_user),
    1=1, _m_user
)

| eval hit = case(
    _m_risk = _entity, 1,
    norm_user = _entity, 1,
    _m_host = _entity, 1,
    1=1, 0
)

| where hit=1

| table _time risk_object source alert alert_status risk_score user host summary
| sort -_time





