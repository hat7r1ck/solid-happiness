

| from datamodel:"Risk.All_Risk"
| eval source = search_name
| lookup RIR-Deduplicate.csv _time risk_object source risk_score OUTPUT alert
| eval _entity = trim(lower("$tok_entity$"))
| where len(_entity) > 0

| eval _m_user = lower(coalesce(
    user,
    src_user,
    dest_user,
    normalized_user,
    user_email
))
| eval _m_mail = lower(coalesce(
    user_email,
    src_user_email,
    dest_user_email
))
| eval _m_host = lower(coalesce(
    host,
    hostname,
    dest_hostname,
    src_hostname,
    dvc,
    ComputerName,
    dest_hostname_normalized,
    src_hostname_normalized
))
| eval _m_ip = coalesce(
    src_ip,
    dest_ip,
    public_ip,
    client_ipaddress,
    src
)
| eval _m_risk = lower(risk_object)

| eval _is_ip_entity = if(match(_entity,"^(\\d{1,3}\\.){3}\\d{1,3}$"),1,0)

| eval hit = if(
    _m_user = _entity
    OR _m_mail = _entity
    OR _m_host = _entity
    OR _m_risk = _entity
    OR (_is_ip_entity = 1 AND cidrmatch(_entity,tostring(_m_ip))),
    1,
    0
)
| where hit = 1

| eval alert_status = case(
    alert = "yes", "Alerted",
    alert = "no",  "Suppressed",
    isnull(alert), "Unknown",
    1 = 1,         "Unknown"
)

| table _time risk_object risk_object_type risk_score source alert alert_status _m_user _m_host _m_ip _m_risk
| sort - _time
