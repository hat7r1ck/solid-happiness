index="sysmgmt_short" sourcetype="wf:snow:naac:db" earliest="$global_time.earliest$" latest="$global_time.latest$"
| eval entity_raw=lower(trim("$tok_user_from_host$"))
| where len(entity_raw)>0
| eval _earliest=relative_time(now(), "$global_time.earliest$")
| eval _latest=if("$global_time.latest$"=="now", now(), relative_time(now(), "$global_time.latest$"))
| where _time>=_earliest AND _time<=_latest
| eval entity_user=mvindex(split(entity_raw,"@"),0)
| eval entity_user=mvindex(split(entity_user,"\\"),-1)
| eval entity_user=replace(entity_user,"\\$a-","")
| eval device_name_l=lower(coalesce(device_name,""))
| eval host_short=mvindex(split(device_name_l,"."),0)
| eval user_l=lower(coalesce(user,""))
| eval assigned_l=lower(coalesce(assigned_to_logon_id,""))
| eval ident_l=lower(coalesce(user_identity,""))
| eval acct_l=lower(coalesce(acct_name,""))
| eval elid_l=lower(coalesce(elid,""))
| eval email_l=lower(coalesce(email_address,""))
| eval assigned_name_l=lower(coalesce(assigned_to_name,""))
| eval user_u=mvindex(split(user_l,"@"),0)
| eval user_u=mvindex(split(user_u,"\\"),-1)
| eval assigned_u=mvindex(split(assigned_l,"@"),0)
| eval assigned_u=mvindex(split(assigned_u,"\\"),-1)
| eval ident_u=mvindex(split(ident_l,"@"),0)
| eval ident_u=mvindex(split(ident_u,"\\"),-1)
| eval acct_u=mvindex(split(acct_l,"@"),0)
| eval acct_u=mvindex(split(acct_u,"\\"),-1)
| eval elid_u=mvindex(split(elid_l,"@"),0)
| eval elid_u=mvindex(split(elid_u,"\\"),-1)
| eval user_core=case(
    match(user_u,"(?i)^[a-z][0-9]{4,10}$"), replace(user_u,"(?i)^.*([a-z][0-9]{4,10})$","\\1"),
    like(user_u,"%.%"), lower(replace(user_u,".[0-9]+$","")),
    1=1, user_u)
| where device_name_l=entity_raw 
    OR host_short=entity_raw 
    OR email_l=entity_raw 
    OR assigned_name_l=entity_raw 
    OR user_u=entity_user 
    OR assigned_u=entity_user 
    OR ident_u=entity_user 
    OR acct_u=entity_user 
    OR elid_u=entity_user 
    OR user_core=entity_user
| eval _entity_has_elid=if(match(_entity_raw,"^.+\\$\\$\\$.+$"),1,0)
| eval hit=case(
    _type="mail" AND (_m_mail=_entity_core OR _m_mail_core=_entity_core),1,
    _type="auto" AND (_m_user_entity_raw OR _entity_raw_has_elid OR _entity_has_elid OR assigned_l=_entity_raw OR elid_l=_entity_raw OR email_l=_entity_raw OR user_l=_entity_raw OR assigned_name_l=_entity_raw),1,
    (_entity_has_elid AND coalesce(_entity_raw,_entity_core)=""),1,
    1=1,0)
| stats latest(_time) as LastSeen
    latest(asset_class) as asset_class
    latest(environment) as environment
    latest(os) as os
    latest(user) as user
    latest(assigned_to_logon_id) as assigned_to_logon_id
    latest(assigned_to_name) as assigned_to_name
    by device_name
| eval "Computer Name"=upper(device_name)
| convert timeformat="%Y-%m-%d %H:%M:%S %Z" ctime(LastSeen) as "Last Seen"
| rename asset_class as "Asset Class", environment as "Environment", os as "Operating System", user as "Last Logged in User", assigned_to_logon_id as "Assigned User ID", assigned_to_name as "Assigned User Full Name"
| table "Last Seen" "Computer Name" "Asset Class" "Environment" "Operating System" "Last Logged in User" "Assigned User ID" "Assigned User Full Name"



| from datamodel:"Risk"."All_Risk"
| fields _time risk_object risk_object_type primary_ioc rule_name risk_score description alert_status prefix source_event_id
| eval _earliest=relative_time(now(), "$global_time.earliest$")
| eval _latest=if("$global_time.latest$"=="now", now(), relative_time(now(), "$global_time.latest$"))
| where _time>=_earliest AND _time<=_latest
| lookup RIR-Deduplicate.csv _time source_event_id risk_score OUTPUT alert
| eval entity_raw=trim(lower(coalesce("$tok_input$","")))
| where len(entity_raw)>0
| eval entity_raw=replace(entity_raw,"\\$a-","")
| eval _type=case(
    match(entity_raw,"(\\$[0-9-a-zA-Z]{4,10}$)"),"naac",
    match(entity_raw,"(\\$[0-9-a-f]{8})$"),"mail",
    match(entity_raw,"\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b"),"wiz",
    match(entity_raw,"\\b[A-Fa-f0-9]{2}([-:])[A-Fa-f0-9]{2}(\\1[A-Fa-f0-9]{2}){4}\\b"),"mac",
    1=1,"other")
| eval _entity_raw=lower(trim(entity_raw))
| eval _entity_user=mvindex(split(_entity_raw,"@"),0)
| eval _entity_user=mvindex(split(_entity_user,"\\"),-1)
| eval _entity_user=replace(_entity_user,"\\$a-","")
| eval _entity_core=case(
    match(_entity_user,"(?i)^[a-z][0-9]{4,10}$"), replace(_entity_user,"(?i)^[a-z]([0-9]{4,10})$","\\1"),
    like(_entity_user,"%.%"), lower(replace(_entity_user,"[0-9]+$","")),
    1=1, _entity_user)
| eval m_user=lower(coalesce(user,src_user,dest_user,identity,user_name,user_normalized,user_email,dest_user_email))
| eval m_user_user=mvindex(split(m_user,"@"),0)
| eval m_user_user=mvindex(split(m_user_user,"\\"),-1)
| eval m_user_user=replace(m_user_user,"\\$a-","")
| eval m_user_core=case(
    match(m_user_user,"(?i)^[a-z][0-9]{4,10}$"), replace(m_user_user,"(?i)^[a-z]([0-9]{4,10})$","\\1"),
    like(m_user_user,"%.%"), lower(replace(m_user_user,"[0-9]+$","")),
    1=1, m_user_user)
| eval m_host=lower(coalesce(host,hostname,dest,dest_nt_host,src_nt_host,ComputerName,src_hostname,dest_hostname,dest_hostname_normalized,src_hostname_normalized))
| eval m_host_short=mvindex(split(m_host,"."),0)
| eval m_mail=lower(coalesce(user_email,src_user_email,dest_user_email,recipients,sender))
| eval m_mail_user=mvindex(split(m_mail,"@"),0)
| eval m_mail_user=mvindex(split(m_mail_user,"\\"),-1)
| eval m_mail_core=case(
    match(m_mail_user,"(?i)^[a-z][0-9]{4,10}$"), replace(m_mail_user,"(?i)^[a-z]([0-9]{4,10})$","\\1"),
    like(m_mail_user,"%.%"), lower(replace(m_mail_user,"[0-9]+$","")),
    1=1, m_mail_user)
| eval m_dom=lower(coalesce(domain,url,domain_http_host,domain_name))
| eval m_url=lower(coalesce(url,url_path,http_host,domain_url))
| eval m_hash=lower(coalesce(file_hash,sha256,process_hash))
| eval m_file=lower(coalesce(file,file_name,process_name,file_path))
| eval m_ip=lower(coalesce(src_ip,dest_ip,dest_ip_dec,src_ip_dec,ip,public_ip,0,0))
| eval m_risk_user=mvindex(split(m_risk_user,"@"),0)
| eval m_risk_user=mvindex(split(m_risk_user,"\\"),-1)
| eval m_risk_core=case(
    match(m_risk_user,"(?i)^[a-z][0-9]{4,10}$"), replace(m_risk_user,"(?i)^[a-z]([0-9]{4,10})$","\\1"),
    like(m_risk_user,"%.%"), lower(replace(m_risk_user,"[0-9]+$","")),
    1=1, m_risk_user)
| eval _entity_has_elid=if(match(_entity_raw,"(?i)\\$entity_raw OR _rw=_entity_user OR _rw_entity_raw OR m_host=_entity_raw OR m_host_short=_entity_raw OR m_user=_entity_user OR m_user_core=_entity_core OR m_mail=_entity_user OR m_mail_core=_entity_core OR m_risk=_entity_raw OR m_risk_core=_entity_core
| eval primary_IOC=if((isnull(primary_ioc) OR primary_ioc=""), "No clear IOC in event",primary_ioc)
| eval primary_IOC_norm=if(replace(primary_IOC,"\\+/\\+.* ",""))
| eval ioc_type=case(
    match(primary_IOC_norm,"(\\$[0-9-a-f]{8}[)$"),"naac",
    match(primary_IOC_norm,"(\\$[0-9-a-f]{8})$"),"mail",
    match(primary_IOC_norm,"\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b"),"ipv4",
    match(primary_IOC_norm,"\\b[A-Fa-f0-9]{2}([-:])[A-Fa-f0-9]{2}(\\1[A-Fa-f0-9]{2}){4}\\b"),"mac",
    match(primary_IOC_norm,"(\\$)[a-z]\\$(\\1)[a-z]\\$(\\$)\\1[?-z]\\$)\\$(\\$)\\(z-0(\\1)[?-z]\\$")),"fileash",
    match(primary_IOC_norm,"(\\$)[?-z]\\$,(?:\\$))+(\\$)\\$,(?:[?-z]\\$|(?:[?-0[?\\1{1}[?-?]\\$\\+)\\+)\\$"),"domain",
    1=1,"other")
| eval _ioc_scheme_defanged=replace(replace(primary_IOC_norm,"(\\$)[\\:\\.hxxp","hxxp"),"(\\$)\\\[\\.\\\]","hxxp")
| eval primary_IOC_defanged=if(ioc_type="domain", replace(_ioc_scheme_defanged,"(\\$)\\\[\\.\\\]","."),if(ioc_type="url", replace(_ioc_scheme_defanged,"(\\$)[:\\.]+",":"),_ioc_scheme_defanged))
| eval url_host_concat=if(match(url_host,"(\\$)[?-z]\\+?[?-z]\\$[?-z]\\(?"(domain,url"), coalesce(mvli_concat,primary_IOC_norm)
| eval risk_object_type=coalesce(risk_object_type, null())
| eval description=coalesce(description,null())
| eval alert_status=coalesce(alert_status,null())
| eval prefix=coalesce(prefix,null())
| eval source_event_id=coalesce(source_event_id,null())
| eval risk_object_type=coalesce(risk_object_type, null())
| fields detection_time risk_object risk_object_type primary_ioc rule_name risk_score description alert_status prefix source_event_id
| eval Time=strftime(detection_time,"%Y-%m-%d %H:%M:%S %Z")
| eval description=coalesce(event_description, rule_description, description)
| table Time risk_object primary_IOC_display rule_name description alert_status
| rename risk_object as "Risk Object", rule_name as "Risk Rule", description as "Risk Description", alert_status as "Alert Status", primary_IOC_display as "Primary IoC"
| sort -Time
