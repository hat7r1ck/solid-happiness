| eval prefix = mvindex(split(source," - "),0)

| eval primary_IOC = case(
    /* Identity rules – identity centric */
    prefix="Identity",
        coalesce(user_email, user_normalized, risk_object, user, src_user, dest_user),

    /* Access rules – auth / sign-in centric */
    prefix="Access",
        coalesce(src, src_ip, dest_ip, dest, user, src_user, dest_user, risk_object),

    /* Endpoint rules – process / file centric */
    prefix="Endpoint",
        coalesce(process_command_line, CommandLine, process_cmdline, cmdline,
                 file_hash_sha256, file_hash, process_hash,
                 file_path, TargetFileName),

    /* Network rules – URL / DNS / IP centric */
    prefix="Network",
        coalesce(url, uri, uri_path, http_url,
                 url_domain, dest_dns,
                 dest_ip, src_ip),

    /* Audit rules – usually user or object the audit touches */
    prefix="Audit",
        coalesce(user, src_user, dest_user, user_email, risk_object),

    /* Threat rules – generic catch-all, prefer file / URL / IP */
    prefix="Threat",
        coalesce(file_hash_sha256, file_hash, process_hash,
                 url, uri, uri_path, http_url,
                 url_domain, dest_dns,
                 dest_ip, src_ip,
                 risk_object),

    /* Fallback for anything weird */
    1=1,
        coalesce(file_hash_sha256, file_hash, process_hash,
                 url, uri, uri_path,
                 dest_ip, src_ip,
                 user_email, user, src_user, dest_user,
                 risk_object)
)

| eval primary_IOC = if(isnull(primary_IOC) OR primary_IOC="",
                        "No clear IOC in event", primary_IOC)
