| stats 
    min(_time) as first_seen
    max(_time) as last_seen
    dc(risk_message) as detection_count
    values(owner) as owners
    values(urgency) as urgencies
    values(risk_score) as risk_scores
    values(disposition_label) as dispositions
    by risk_object

| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S")
| eval last_seen  = strftime(last_seen, "%Y-%m-%d %H:%M:%S")

| eval owners      = mvjoin(mvindex(mvsort(owners),0,4), ", ")
| eval urgencies   = mvjoin(mvindex(mvsort(urgencies),0,4), ", ")
| eval risk_scores = mvjoin(mvindex(mvsort(risk_scores),0,4), ", ")
| eval dispositions = mvjoin(mvindex(mvsort(dispositions),0,4), ", ")

| sort - last_seen

| rename 
    risk_object     AS "Risk Object",
    detection_count AS "Detection Count",
    risk_scores     AS "Risk Scores",
    dispositions    AS "Dispositions"

| fields last_seen first_seen "Risk Object" "Detection Count" "Risk Scores" "Dispositions" owners urgencies



| stats 
    min(_time) as first_seen
    max(_time) as last_seen
    dc(rule_title) as detection_count
    values(coalesce(mc_incident_id, source_guid, orig_sid)) as mc_ids
    values(coalesce(risk_message, rule_title, search_name)) as rules
    values(owner) as owners
    values(status_label) as statuses
    values(urgency) as urgencies
    values(risk_score) as risk_scores

| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S")
| eval last_seen  = strftime(last_seen, "%Y-%m-%d %H:%M:%S")

| rename 
    detection_count as "Detection Count",
    mc_ids as "MC Incident IDs",
    rules as "Rules",
    owners as "Owners",
    statuses as "Statuses",
    urgencies as "Urgency",
    risk_scores as "Risk Scores",
    first_seen as "First Seen",
    last_seen as "Last Seen"

| fields "Last Seen" "First Seen" "Detection Count" "Rules" "Owners" "Statuses" "Urgency" "Risk Scores" "MC Incident IDs"



| eval detection_time = _time
| eval rule_name = coalesce(risk_message, rule_title, search_name)
| eval rule_description = description

| table detection_time rule_name rule_description source_guid owner status_label urgency

| eval detection_time = strftime(detection_time, "%Y-%m-%d %H:%M:%S")

| sort - detection_time

| rename
    detection_time as "Detection Time",
    owner as "Owner",
    status_label as "Status",
    urgency as "Urgency",
    source_guid as "MC Incident ID",
    rule_name as "Rule",
    rule_description as "Rule Description"

| fields "Detection Time" "Owner" "Status" "Urgency" "MC Incident ID" "Rule" "Rule Description"
