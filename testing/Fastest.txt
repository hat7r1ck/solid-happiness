| eval det_date=strftime(_time,"%Y-%m-%d")
| eval rule_name=coalesce(risk_message, rule_title, search_name, "Unknown rule")
| eval contrib=coalesce(contributing_events_search,"No related search")
| where len(rule_name)>0
| eval source="Date: ".det_date
| eval target="Rule: ".rule_name
| eval edge_type="date_to_rule"
| eval weight=1
| table source target edge_type weight
| appendpipe [
    | eval source="Rule: ".rule_name
    | eval target="Contrib: ".contrib
    | eval edge_type="rule_to_contrib"
    | eval weight=1
    | table source target edge_type weight
]







| eval det_date = strftime(_time,"%Y-%m-%d")
| eval rule_name = coalesce(risk_message, rule_title, search_name)
| eval contrib   = coalesce(contributing_events_search, "No related search")

* build Date → Rule edges *
| eval source   = "Date: " . det_date
| eval target   = "Rule: " . rule_name
| eval edge_type = "date_to_rule"
| eval weight    = 1

* keep helper fields so appendpipe can reuse them *
| table source target edge_type weight det_date rule_name contrib

* build Rule → Contrib edges using the same rows *
| appendpipe [
    eval source    = "Rule: " . rule_name
    | eval target  = "Contrib: " . contrib
    | eval edge_type = "rule_to_contrib"
    | eval weight    = 1
    | table source target edge_type weight
]





| eval rule_name = coalesce(risk_message, rule_title, search_name)
| eval date_node   = "Date: " . strftime(_time,"%Y-%m-%d")
| eval rule_node   = "Rule: " . rule_name
| eval contrib_raw = mvindex(contributing_events_search,0)
| eval contrib_node = if(isnull(contrib_raw) OR contrib_raw="",
                         "Contrib: (none defined)",
                         "Contrib: " . contrib_raw)

| eval source = date_node
| eval target = rule_node
| eval weight = 1
| eval edge_type = "date_to_rule"

| appendpipe [
    eval source   = rule_node
    | eval target = contrib_node
    | eval weight = 1
    | eval edge_type = "rule_to_contrib"
]

| table source target weight edge_type



| makeresults
| eval host_raw  = "~",
      ip_raw    = "~",
      cloud_raw = "~",
      user_raw  = trim("$form.tok_entity$")

| eval host  = if(host_raw=="~", null(), host_raw),
      ip    = if(ip_raw=="~",   null(), ip_raw),
      cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(NOT isnull(parts))

| mvexpand parts
| eval chars = split(parts,"")
| mvexpand chars

| eval ci = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)

| stats values(ci) as ci by parts
| eval built = mvjoin(ci,"")

| stats values(built) as built

| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex






| eval rule_name = coalesce(risk_message, rule_title, search_name)
| eval detection_date = strftime(_time, "%Y-%m-%d")
| eval ce_label = contributing_events_search
| where isnotnull(ce_label) AND ce_label != ""
| eval node_date = "Date: " . detection_date
| eval node_rule = "Rule: " . rule_name
| eval node_ce   = "Contrib: " . ce_label

| stats count as weight by node_date node_rule node_ce

| eval source = node_date
| eval target = node_rule
| eval edge_type = "date_to_rule"

| appendpipe [
    eval source = node_rule
    | eval target = node_ce
    | eval edge_type = "rule_to_contrib"
]

| table source target weight edge_type




1. Suppressed_Detections_Count

Purpose: Count of suppressed detections tied to this entity.

Visualization: Single Value (recommended) or Single Value Radial.

SPL:

| lookup rit_duplicate_truth.csv risk_object 
      OUTPUT previousNotable
| where lower(risk_object)=lower(_entity)
| where isnotnull(previousNotable)
| stats count as suppressed_detections


⸻

2. Disposition_Breakdown

Purpose: Frequency of dispositions for this entity across the 90-day window.

Visualization: Bar Chart (horizontal or vertical)

SPL:

<your 90_day_entity_base_search>
| stats count as ct by disposition_label
| sort -ct


⸻

3. Urgency_Breakdown

Purpose: Urgency mix for all detections tied to this entity.

Visualization: Pie Chart

SPL:

<your 90_day_entity_base_search>
| stats count as ct by urgency
| sort -ct


⸻

4. Suppression_Status_Source

Purpose: Show why suppressions occurred (previousStatus) and which rule source generated them.

Visualization: Bar Chart

SPL:

| lookup rit_duplicate_truth.csv risk_object 
      OUTPUT previousStatus source
| where lower(risk_object)=lower(_entity)
| where isnotnull(previousStatus)
| stats count as ct by previousStatus source
| sort -ct


⸻

Left to right on the bottom row:
	1.	Suppressed_Detections_Count
	2.	Disposition_Breakdown
	3.	Urgency_Breakdown
	4.	Suppression_Status_Source






<your_90_day_entity_search>
| eval rule = coalesce(risk_message, rule_title, search_name)
| eval detection_date=strftime(_time,"%Y-%m-%d")
| stats count values(rule) as rules by detection_date
| eval _time=strptime(detection_date,"%Y-%m-%d")
| table _time count rules
| sort _time





<your 90-day entity base search here>
| eval label = coalesce(risk_message, rule_title, search_name)
| bin _time span=1d
| stats count avg(risk_score) as avg_risk by _time urgency label



<base search>
| search _is_entity=1
| eval detection_ts=_time
| eval label=coalesce(risk_message, rule_title, search_name)
| eval y_val=case(
    urgency="critical", 4,
    urgency="high", 3,
    urgency="medium", 2,
    urgency="low", 1,
    1=1, 0
)
| table detection_ts y_val label urgency





1. KPI Searches

These all assume a base macro or input token for entity resolution. Adjust the base search line to your environment. Everything downstream is consistent.

1.1 KPI_Detections90

<base search for ES notables or risk modifiers>
| search _is_entity=1
| stats count as detections_90

1.2 KPI_UniqueRules90

<base search>
| search _is_entity=1
| stats count by rule_title
| stats count as unique_rules_90

1.3 KPI_UniqueHosts90

<base search>
| search _is_entity=1
| stats count by src_host
| stats count as unique_hosts_90

1.4 KPI_UniqueIPs90

<base search>
| search _is_entity=1
| stats count by src_ip
| stats count as unique_ips_90


⸻

2. Primary Timeline Panel

Use this for the middle wide panel.
Visualization: Event Timeline.
Uses the Splunk Timeline Viz fields: start, end, label, group, color.

2.1 Behavior_Timeline_90

<base search>
| search _is_entity=1
| eval start=_time
| eval end=_time+60
| eval label=coalesce(risk_message, rule_title, search_name)
| eval group=urgency
| eval color=urgency
| table start end label group color

This creates a one minute bar so the timeline displays cleanly.

⸻

3. Scatterplot Fallback

Use this only if Event Timeline breaks or is not available.
This is the variant that avoids epoch display.

3.1 Behavior_Scatter_Fallback

<base search>
| search _is_entity=1
| eval detection_ts=_time
| eval y_val=case(
    urgency="critical", 4,
    urgency="high",     3,
    urgency="medium",   2,
    urgency="low",      1,
    1=1,                0
)
| eval label=coalesce(risk_message, rule_title, search_name)
| table detection_ts y_val label urgency

X axis is detection_ts (time).
Y axis is ordinal based on urgency.
Category can be label or urgency.

⸻

4. Suppressed Events (Truth Table Audit)

Place this in Lookback and Audit.
Pulls indicators suppressed due to false positive classification.

4.1 Suppressed_TruthTable

inputlookup RIR-Deduplicate.csv
| search alert="yes"
| fillnull value="unknown" suppression_reason
| table _time ioc_value suppression_reason analyst user disposition

If you need entity filtering:

inputlookup RIR-Deduplicate.csv
| search alert="yes"
| where match(ioc_value, $tok_lb_regex$)
| fillnull value="unknown" suppression_reason
| table _time ioc_value suppression_reason analyst user disposition


⸻

5. Entity Lookup Cards (for swapping device and identity panels)

These are for the top right cards if you reorganize them.

5.1 Identity_Lookup

| makeresults 
| eval user="$form.user$"
| lookup identities_lookup user OUTPUT display_name email title department
| table display_name email title department

5.2 Host_Lookup

| makeresults
| eval host="$form.host$"
| lookup assets_lookup host OUTPUT os version owner criticality
| table os version owner criticality


⸻

eval detection_ts=_time
eval label=coalesce(risk_message, rule_title, search_name)
eval y_val=case(
    urgency="critical", 3,
    urgency="high", 2,
    urgency="medium", 1,
    1=1, 0
)
fields detection_ts y_val label urgency




| eval detection_ts=_time
| eval label=coalesce(risk_message, rule_title, search_name)
| eval y_val=case(
    urgency="critical", 3,
    urgency="high", 2,
    urgency="medium", 1,
    1=1, 0
)
| table detection_ts y_val label urgency




| eval start=_time
| eval label=coalesce(risk_message, rule_title, search_name)
| eval group=urgency
| eval tooltip=rule_description
| table start label group tooltip




| eval detection_ts = strftime(_time,"%Y-%m-%d %H:%M:%S")
| eval detection_ts = strptime(detection_ts,"%Y-%m-%d %H:%M:%S")
| eval rule_name = coalesce(risk_message, rule_title, search_name)
| eval description = rule_description
| eval category = urgency
| streamstats count as evt_y
| table detection_ts evt_y rule_name category description urgency






| eval detection_time=_time
| eval rule_name=coalesce(risk_message, rule_title, search_name)
| eval evt_y = 1
| table detection_time evt_y rule_name urgency



| makeresults
| eval host_raw  = trim("$tok_lb_host$"),
      ip_raw     = trim("$tok_lb_ip$"),
      cloud_raw  = trim("$tok_lb_cloud$"),
      user_raw   = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~" OR host_raw="", null(), host_raw),
      ip    = if(ip_raw=="~" OR ip_raw="", null(), replace(ip_raw,"\.", "\\.")),
      cloud = if(cloud_raw=="~" OR cloud_raw="", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~" OR user_raw="", null(), user_raw)

| eval safe_host  = if(isnull(host)  OR host=="",  null(), host)
| eval safe_ip    = if(isnull(ip)    OR ip=="",    null(), ip)
| eval safe_cloud = if(isnull(cloud) OR cloud=="", null(), cloud)
| eval safe_user  = if(isnull(user)  OR user=="",  null(), user)

| eval parts_raw = mvappend(safe_host, safe_ip, safe_cloud, safe_user)
| eval parts = mvfilter(isnotnull(parts_raw))

| eval fallback = if(mvcount(parts)==0, "EMPTY_SENTINEL", null())
| eval parts = if(fallback="EMPTY_SENTINEL", mvappend(""), parts)

| mvexpand parts
| eval chars = split(parts,"")
| mvexpand chars
| streamstats count as pos by parts

| eval step1 = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)

| stats list(step1) as step1 by parts
| eval built = mvjoin(step1,"")

| stats list(built) as built
| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex



| makeresults
| eval host_raw = trim("$tok_lb_host$"),
      ip_raw    = trim("$tok_lb_ip$"),
      cloud_raw = trim("$tok_lb_cloud$"),
      user_raw  = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~" OR host_raw="", null(), host_raw),
      ip    = if(ip_raw=="~" OR ip_raw="", null(), replace(ip_raw,"\.", "\\.")),
      cloud = if(cloud_raw=="~" OR cloud_raw="", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~" OR user_raw="", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(isnotnull(parts) AND parts!="")

| eval fallback = if(mvcount(parts)==0, "EMPTY_SENTINEL", null())
| eval parts = if(fallback="EMPTY_SENTINEL", mvappend(""), parts)

| mvexpand parts
| eval chars = split(parts,"")
| mvexpand chars
| streamstats count as pos by parts

| eval step1 = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)

| stats list(step1) as step1 by parts
| eval built = mvjoin(step1,"")

| stats list(built) as built
| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex




| makeresults
| eval host_raw = trim("$tok_lb_host$"),
      ip_raw    = trim("$tok_lb_ip$"),
      cloud_raw = trim("$tok_lb_cloud$"),
      user_raw  = trim("$tok_lb_user$")
| eval host  = if(host_raw=="~", null(), host_raw),
      ip    = if(ip_raw=="~", null(), replace(ip_raw,"\.", "\\.")),
      cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~", null(), user_raw)
| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvmap(parts, if(isnull(parts) OR parts=="", null(), parts))
| eval parts = mvfilter(NOT isnull(parts))
| mvexpand parts
| eval chars = split(parts,"")
| mvexpand chars
| streamstats count as pos by parts
| eval step1 = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)
| stats list(step1) as step1 by parts
| eval built = mvjoin(step1,"")
| stats list(built) as built
| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)
| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host$"),
      ip_raw    = trim("$tok_lb_ip$"),
      cloud_raw = trim("$tok_lb_cloud$"),
      user_raw  = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~", null(), host_raw),
      ip    = if(ip_raw=="~", null(), replace(ip_raw,"\.", "\\.")),
      cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(isnotnull(parts))

| mvexpand parts
| eval chars = split(parts, "")
| mvexpand chars

| eval ci = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)

| stats values(ci) as ci by parts
| eval built = mvjoin(ci, "")

| stats values(built) as built
| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host$"),
      ip_raw    = trim("$tok_lb_ip$"),
      cloud_raw = trim("$tok_lb_cloud$"),
      user_raw  = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~", null(), host_raw),
      ip    = if(ip_raw=="~", null(), replace(ip_raw,"\.", "\\.")),
      cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
      user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(NOT isnull(parts))

| mvexpand parts
| eval chars = split(parts, "")
| mvexpand chars

| eval ci = case(
      match(chars,"[A-Za-z]"), "[" . lower(chars) . upper(chars) . "]",
      chars=".", "\\.",
      1=1, chars
)

| stats values(ci) as ci by parts
| eval built = mvjoin(ci, "")

| stats values(built) as built
| eval pattern_core = case(
      mvcount(built)==0, "",
      mvcount(built)==1, mvindex(built,0),
      mvcount(built)>1, "(" . mvjoin(built,"|") . ")"
)

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex





| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~", null(), host_raw),
       ip    = if(ip_raw=="~", null(), replace(ip_raw, "\.", "\\.")),
       cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
       user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvmap(parts, if(isnull(parts) OR parts=="", null(), parts))
| eval parts = mvfilter(NOT isnull(parts))

| mvexpand parts
| eval step1 = replace(parts, "([A-Za-z])", "[\\1]")
| eval expanded = replace(step1, "\\[([A-Za-z])\\]", "[" . lower("\\1") . upper("\\1") . "]")

| stats values(expanded) as expanded
| eval pattern_core = case(
      mvcount(expanded)==0, "",
      mvcount(expanded)==1, mvindex(expanded,0),
      mvcount(expanded)>1, "(" . mvjoin(expanded,"|") . ")"
  )

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex




| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")
| eval host  = if(host_raw=="~", null(), host_raw),
       ip    = if(ip_raw=="~", null(), replace(ip_raw, "\.", "\\.")),
       cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
       user  = if(user_raw=="~", null(), user_raw)
| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvmap(parts, if(isnull(parts) OR parts=="", null(), parts))
| eval parts = mvfilter(NOT isnull(parts))
| eval expanded = mvmap(parts, replace(parts, "([A-Za-z])", "[\\1" . lower("\\1") . "]"))
| eval pattern_core = case(
      mvcount(expanded)==0, "",
      mvcount(expanded)==1, mvindex(expanded,0),
      mvcount(expanded)>1, "(" . mvjoin(expanded,"|") . ")"
  )
| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex




| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")

| eval host  = if(host_raw=="~", null(), host_raw),
       ip    = if(ip_raw=="~", null(), replace(ip_raw, "\.", "\\.")),
       cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
       user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvfilter(isnotnull(mvappend(host, ip, cloud, user)))

/* Case-insensitive expansion: turn 'abc123' into '[Aa][Bb][Cc]123' */
| eval expanded = mvmap(parts,
      replace(parts, "([A-Za-z])", "[\\1" . lower("\\1") . "]")
  )

| eval pattern_core = case(
      mvcount(expanded)==0, "",
      mvcount(expanded)==1, mvindex(expanded,0),
      mvcount(expanded)>1, "(" . mvjoin(expanded,"|") . ")"
  )

| eval regex = "\"/.*" . pattern_core . ".*/\""
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")
       
| eval host  = if(host_raw=="~", null(), host_raw),
       ip    = if(ip_raw=="~", null(), replace(ip_raw, "\.", "\\.")),
       cloud = if(cloud_raw=="~", null(), mvindex(split(cloud_raw,"@"),0)),
       user  = if(user_raw=="~", null(), user_raw)

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(isnotnull(parts))

| eval regex_core = mvjoin(parts, "|")
| eval regex = "/.*".regex_core.".*/"
| table regex






| makeresults

| eval host_raw  = trim(coalesce("$tok_lb_host$", "")),
       ip_raw    = trim(coalesce("$tok_lb_ip$", "")),
       cloud_raw = trim(coalesce("$tok_lb_cloud$", "")),
       user_raw  = trim(coalesce("$tok_lb_user$", ""))

| eval regex = ""

| eval regex = if(host_raw!="",
                  regex . host_raw . "|",
                  regex)

| eval regex = if(ip_raw!="",
                  regex . replace(ip_raw, "\.", "\\.") . "|",
                  regex)

| eval regex = if(cloud_raw!="",
                  regex . mvindex(split(cloud_raw,"@"),0) . "|",
                  regex)

| eval regex = if(user_raw!="",
                  regex . user_raw,
                  regex)

| eval regex = trim(regex, "|")

| eval regex = "/.*" . regex . ".*/"

| table regex


| makeresults

| eval host_raw = trim(coalesce("$tok_lb_host$", "")),
       ip_raw   = trim(coalesce("$tok_lb_ip$", "")),
       cloud_raw= trim(coalesce("$tok_lb_cloud$", "")),
       user_raw = trim(coalesce("$tok_lb_user$", ""))

| eval host  = if(host_raw="", null(), host_raw),
       ip    = if(ip_raw="", null(), replace(ip_raw, "\.", "\\.")),
       cloud = if(cloud_raw="", null(), mvindex(split(cloud_raw,"@"),0)),
       user  = if(user_raw="", null(), user_raw)

| eval regex_parts = ""
| eval regex_parts = regex_parts . if(isnull(host),"", "(" . host . ")|")
| eval regex_parts = regex_parts . if(isnull(ip),"", "(" . ip . ")|")
| eval regex_parts = regex_parts . if(isnull(cloud),"", "(" . cloud . ")|")
| eval regex_parts = regex_parts . if(isnull(user),"", "(" . user . ")|")

| eval regex_parts = rtrim(regex_parts, "|")

| eval regex = "/.*" . regex_parts . ".*/"

| table regex


| makeresults
| eval host_raw = trim(coalesce("$tok_lb_host$", "")),
       ip_raw   = trim(coalesce("$tok_lb_ip$", "")),
       cloud_raw= trim(coalesce("$tok_lb_cloud$", "")),
       user_raw = trim(coalesce("$tok_lb_user$", ""))

| eval host  = if(host_raw != "", host_raw, null()),
       ip    = if(ip_raw != "", replace(ip_raw, "\.", "\\."), null()),
       cloud = if(cloud_raw != "", mvindex(split(cloud_raw, "@"), 0), null()),
       user  = if(user_raw != "", user_raw, null())

| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(isnotnull(parts) AND parts != "")

| mvexpand parts
| eval chars = split(parts, "")
| eval chars_ci = mvmap(
        chars,
        if(match(<<FIELD>>, "[A-Za-z]"),
            "[" . lower(<<FIELD>>) . upper(<<FIELD>>) . "]",
            if(<<FIELD>>=".", "\\.", <<FIELD>>)
        )
  )
| eval built = mvjoin(chars_ci, "")
| stats values(built) as built
| eval regex = "/.*" . mvjoin(built, "|") . ".*/"
| table regex



| mvexpand parts
| eval chars = split(parts,"")
| eval chars_ci = mvmap(
        chars,
        if(match(<<FIELD>>,"[A-Za-z]"),
            "[" . lower(<<FIELD>>) . upper(<<FIELD>>) . "]",
            if(<<FIELD>>=".", "\\.", <<FIELD>>)
        )
  )
| eval built = mvjoin(chars_ci,"")
| stats values(built) as built
| eval regex = "/.*" . mvjoin(built,"|") . ".*"
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host\\\\|$"),
       ip_raw   = trim("$tok_lb_ip\\\\|$"),
       cloud_raw= trim("$tok_lb_cloud\\\\|$"),
       user_raw = trim("$tok_lb_user\\\\|$")
| eval host  = if(host_raw != "", host_raw, null()),
       ip    = if(ip_raw != "", replace(ip_raw, "\.", "\\."), null()),
       cloud = if(cloud_raw != "", mvindex(split(cloud_raw, "@"), 0), null()),
       user  = if(user_raw != "", user_raw, null())

| eval parts = mvappend(host, ip, cloud, user)

| eval parts = mvfilter(isnotnull(parts) AND parts != "")
| eval regex_core = if(mvcount(parts)==0, "", mvjoin(parts, "|"))
| eval regex = "/.*" . regex_core . ".*/"
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host\\\\|$"),
       ip_raw   = trim("$tok_lb_ip\\\\|$"),
       cloud_raw= trim("$tok_lb_cloud\\\\|$"),
       user_raw = trim("$tok_lb_user\\\\|$")
| eval host  = if(host_raw != "", host_raw, null()),
       ip    = if(ip_raw != "", replace(ip_raw, "\.", "\\."), null()),
       cloud = if(cloud_raw != "", mvindex(split(cloud_raw, "@"), 0), null()),
       user  = if(user_raw != "", user_raw, null())
| eval parts = mvfilter(isnotnull(mvappend(host, ip, cloud, user)))
| eval regex_core = if(mvcount(parts)==0, "", mvjoin(parts, "|"))
| eval regex = "/.*" . regex_core . ".*/"
| table regex





"query": "| makeresults
| eval host_raw = trim(\"$tok_lb_host\\|$\"),
       ip_raw   = trim(\"$tok_lb_ip\\|$\"),
       cloud_raw= trim(\"$tok_lb_cloud\\|$\"),
       user_raw = trim(\"$tok_lb_user\\|$\")
| eval host  = if(host_raw != \"\", host_raw, null()),
       ip    = if(ip_raw != \"\", replace(ip_raw, \"\\.\", \"\\\\.\"), null()),
       cloud = if(cloud_raw != \"\", mvindex(split(cloud_raw, \"@\"), 0), null()),
       user  = if(user_raw != \"\", user_raw, null())
| eval parts = mvfilter(isnotnull(mvappend(host, ip, cloud, user)))
| eval regex_core = if(mvcount(parts)==0, \"\", mvjoin(parts, \"|\"))
| eval regex = \"/.*\" . regex_core . \".*/\"
| table regex"


"query": "| makeresults
| eval host_raw = trim(\"$tok_lb_host|$\"),
       ip_raw   = trim(\"$tok_lb_ip|$\"),
       cloud_raw= trim(\"$tok_lb_cloud|$\"),
       user_raw = trim(\"$tok_lb_user|$\")
| eval host  = if(host_raw != \"\", host_raw, null()),
       ip    = if(ip_raw != \"\", replace(ip_raw, \"\\.\", \"\\\\.\"), null()),
       cloud = if(cloud_raw != \"\", mvindex(split(cloud_raw, \"@\"), 0), null()),
       user  = if(user_raw != \"\", user_raw, null())
| eval parts = mvfilter(isnotnull(mvappend(host, ip, cloud, user)))
| eval regex_core = if(mvcount(parts)==0, \"\", mvjoin(parts, \"|\"))
| eval regex = \"/.*\" . regex_core . \".*/\"
| table regex"


| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")

| eval host  = if(host_raw!="", host_raw, null()),
       ip    = if(ip_raw!="", replace(ip_raw,"\.", "\\."), null()),
       cloud = if(cloud_raw!="", mvindex(split(cloud_raw,"@"),0), null()),
       user  = if(user_raw!="", user_raw, null())

| eval parts = mvfilter(isnotnull(mvappend(host, ip, cloud, user)))

| eval regex_core = mvjoin(parts, "|")

| eval regex = "/.*".regex_core.".*/"

| table regex




| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")
| eval host  = if(host_raw!="", host_raw, null()),
       ip    = if(ip_raw!="", replace(ip_raw, "\\.", "\\\\."), null()),
       cloud = if(cloud_raw!="", mvindex(split(cloud_raw,"@"),0), null()),
       user  = if(user_raw!="", user_raw, null())
| eval part1 = if(isnull(host), null(), host)
| eval part2 = if(isnull(ip), null(), ip)
| eval part3 = if(isnull(cloud), null(), cloud)
| eval part4 = if(isnull(user), null(), user)
| eval parts = mvappend(part1, part2, part3, part4)
| eval parts = mvindex(parts, 0, mvcount(parts)-1)
| eval regex_core = if(mvcount(parts)==0, "", mvjoin(parts, "|"))
| eval regex = "/.*" . regex_core . ".*/"
| table regex


| makeresults
| eval host_raw = trim("$tok_lb_host$"),
       ip_raw   = trim("$tok_lb_ip$"),
       cloud_raw= trim("$tok_lb_cloud$"),
       user_raw = trim("$tok_lb_user$")
| eval host  = if(host_raw!="", host_raw, null()),
       ip    = if(ip_raw!="", replace(ip_raw, "\.", "\\."), null()),
       cloud = if(cloud_raw!="", mvindex(split(cloud_raw,"@"),0), null()),
       user  = if(user_raw!="", user_raw, null())
| eval parts = mvappend(host, ip, cloud, user)
| eval parts = mvfilter(isnotnull(parts) AND parts!="")
| eval regex_core = if(mvcount(parts)==0, "", mvjoin(parts, "|"))
| eval regex = "/.*" . regex_core . ".*/"
| table regex


| makeresults
| eval host = trim("$tok_lb_host|default:\"\"$"),
      ip   = trim("$tok_lb_ip|default:\"\"$"),
      cloud= trim("$tok_lb_cloud|default:\"\"$"),
      user = trim("$tok_lb_user|default:\"\"$")
| eval parts = mvappend(
        if(len(host)>0, host, null()),
        if(len(ip)>0, ip, null()),
        if(len(cloud)>0, cloud, null()),
        if(len(user)>0, user, null())
      )
| mvexpand parts
| eval chars = split(parts,"")
| eval chars = mvmap(
        chars,
        if(
            match(<<chars>>,"[A-Za-z]"),
            "[" . lower(<<chars>>) . upper(<<chars>>) . "]",
            if(<<chars>>=".", "\\.", <<chars>>)
        )
  )
| eval built = mvjoin(chars,"")
| stats values(built) as built
| eval regex = "/.*" . mvjoin(built, "|") . ".*"
| table regex


| makeresults

| eval host_raw = trim("$tok_lb_host$"),
      ip_raw   = trim("$tok_lb_ip$"),
      cloud_raw = trim("$tok_lb_cloud$"),
      user_raw  = trim("$tok_lb_user$")

| eval host  = if(len(host_raw)>0, host_raw, null())
| eval ip    = if(len(ip_raw)>0, replace(ip_raw, "\.", "\\."), null())
| eval cloud = if(len(cloud_raw)>0, mvindex(split(cloud_raw,"@"),0), null())
| eval user  = if(len(user_raw)>0, user_raw, null())

| eval parts = mvappend(host, ip, cloud, user)

| eval parts = mvfilter(len(parts)>0)

| eval parts_ci = if(
        mvcount(parts)==0,
        null(),
        mvmap(parts, replace(parts, "([A-Za-z])", "[\\1\\U\\1]"))
)

| eval regex_core = if(
        mvcount(parts_ci)==0,
        "",
        mvjoin(parts_ci, "|")
)

| eval regex = "/.*" . regex_core . ".*/"

| table regex


| makeresults
| eval host = trim("$tok_lb_host$"),
      ip = trim("$tok_lb_ip$"),
      cloud = trim("$tok_lb_cloud$"),
      user = trim("$tok_lb_user$")
| eval parts = mvappend(
        if(len(host)>0, host, null()),
        if(len(ip)>0, ip, null()),
        if(len(cloud)>0, cloud, null()),
        if(len(user)>0, user, null())
      )
| mvexpand parts
| eval built = replace(parts, "([A-Za-z])", "[\\1\\U\\1]")
| eval built = replace(built, "\\.", "\\.")
| stats values(built) as built
| eval regex = "/.*" . mvjoin(built, "|") . ".*/"
| table regex



Core Backgrounds
	•	Primary Background: #1e1e2e
	•	Panel Surface: #242434
	•	Panel Border: #313244

Core Text
	•	Primary Text: #cdd6f4
	•	Secondary Text: #a6adc8
	•	Muted Text: #6c7086

Accent Blue Family
	•	Accent Blue Strong: #89b4fa
	•	Accent Blue Soft: #74c7ec
	•	Accent Blue Deep: #1e66f5

Catppuccin-Leaned Accent Set
	•	Lavender: #b4befe
	•	Teal: #94e2d5
	•	Rosewater: #f5e0dc
	•	Peach (reserved for warnings): #fab387
	•	Red (critical only): #f38ba8

⸻

Use deep background + strong accent.
	•	Background: #242434
	•	Border: #313244
	•	Text: #cdd6f4
	•	Value Color: #89b4fa
	•	Secondary Value: #74c7ec

Keep the KPI row visually linked with the same border and padding.

Tables
	•	Header background: #313244
	•	Header text: #cdd6f4
	•	Row background (odd): #242434
	•	Row background (even): #1e1e2e
	•	Selected row border: #89b4fa

Timeline Chart
	•	Point Color (default): #89b4fa
	•	High urgency: #f38ba8
	•	Medium urgency: #fab387
	•	Low urgency: #74c7ec
	•	Gridlines: #313244
	•	Axis labels: #a6adc8

Cards Row

Identity, Device, Rule Mix, Dispositions
	•	Background: #242434
	•	Header Text: #cdd6f4
	•	Field Label: #a6adc8
	•	Field Value: #cdd6f4
	•	Badges or counts (small highlight): #74c7ec

⸻

PANEL LIST WITH MAPPED QUERIES

⸻

1. KPI STRIP

Panel: KPI_Detections90

Location: Pulse Bar, leftmost

| stats count as detections_90

Panel: KPI_Distinct_Rules

Location: Pulse Bar

| stats dc(rule_name) as distinct_rules

Panel: KPI_Distinct_Hosts

Location: Pulse Bar

| stats dc(_m_host) as distinct_hosts

Panel: KPI_Distinct_IPs

Location: Pulse Bar, rightmost

| stats dc(_m_ip) as distinct_ips


⸻

2. BEHAVIOR TIMELINE

Panel: Behavior_Timeline

Location: Full width under KPI strip

| eval detection_time=_time
| eval rule_name=coalesce(risk_message, rule_title, search_name)
| table detection_time rule_name urgency status_label risk_score source_guid rule_description
| eval category=case(
    urgency="high","High",
    urgency="medium","Medium",
    1=1,"Low"
)

Chart: scatter
X: detection_time
Y: category
Color: urgency

⸻

3. CONTEXT TILE ROW

Panel: Identity_Card

Location: Bottom Row, Far Left

| table user_normalized user_first user_last job_title manager_name email_address user_work_state user_work_country user_startDate

Panel: Device_Card

Location: Bottom Row, Mid Left

| stats dc(_m_host) as distinct_hosts,
        values(_m_host) as hosts,
        dc(_m_ip) as distinct_ips,
        values(_m_ip) as ips,
        min(_time) as first_seen,
        max(_time) as last_seen
| eval first_seen=strftime(first_seen,"%Y-%m-%d %H:%M:%S")
| eval last_seen=strftime(last_seen,"%Y-%m-%d %H:%M:%S")

Panel: Rule_Mix_Card

Location: Bottom Row, Mid Right

| stats count as detections by rule_name urgency
| sort -detections

Use bar chart, color by urgency.

Panel: Disposition_Card

Location: Bottom Row, Far Right

| stats values(disposition_label) as dispositions,
        dc(disposition_label) as distinct_dispos,
        count as detection_count,
        min(_time) as first_seen,
        max(_time) as last_seen
| eval first_seen=strftime(first_seen,"%Y-%m-%d %H:%M:%S")
| eval last_seen=strftime(last_seen,"%Y-%m-%d %H:%M:%S")


⸻

CHAIN SEARCH BLOCKS ONLY
case_summary

| stats
    min(_time) as first_seen
    max(_time) as last_seen
    dc(rule_name) as detection_count
    values(coalesce(mc_incident_id, source_guid, orig_sid)) as mc_ids
    values(rule_name) as rules
    values(owner) as owners
    values(status_label) as statuses
    values(urgency) as urgencies
    values(risk_score) as risk_scores
    by risk_object

| eval first_seen=strftime(first_seen,"%Y-%m-%d %H:%M:%S")
| eval last_seen=strftime(last_seen,"%Y-%m-%d %H:%M:%S")

| eval owners=mvjoin(mvindex(mvsrt(owners),0,4),", ")
| eval urgencies=mvjoin(mvindex(mvsrt(urgencies),0,4),", ")
| eval statuses=mvjoin(mvindex(mvsrt(statuses),0,4),", ")
| eval risk_scores=mvjoin(mvindex(mvsrt(risk_scores),0,4),", ")
| eval rules=mvjoin(mvindex(mvsrt(rules),0,4),", ")
| eval mc_ids=mvjoin(mvindex(mvsrt(mc_ids),0,4),", ")

Chain: ctfc_entity_detection_history

| eval detection_time=_time
| eval rule_name=coalesce(risk_message, rule_title, search_name)
| eval rule_description=description

| table detection_time rule_name rule_description source_guid owner status_label urgency risk_score

| eval detection_time=strftime(detection_time,"%Y-%m-%d %H:%M:%S")
| sort -detection_time




Create input boxes 

Use four input fields:
	•	tok_lb_host
	•	tok_lb_ip
	•	tok_lb_cloud
	•	tok_lb_user

2. SPL powered “Regex Generator” panel

| makeresults
| eval raw_host=trim(lower("$tok_lb_host$")),
       raw_ip=trim(lower("$tok_lb_ip$")),
       raw_cloud=trim(lower("$tok_lb_cloud$")),
       raw_user=trim(lower("$tok_lb_user$"))

| eval host_clean = if(len(raw_host)>0,
      replace(raw_host,"([A-Za-z])","[\\1\\u\\1]"),
      null())

| eval ip_clean = if(len(raw_ip)>0,
      replace(raw_ip,"\\.","\\."),
      null())

| eval cloud_local = lower(replace(raw_cloud,"@.*",""))
| eval cloud_clean = if(len(cloud_local)>0,
      replace(cloud_local,"([A-Za-z])","[\\1\\u\\1]"),
      null())

| eval user_clean = if(len(raw_user)>0,
      replace(raw_user,"([A-Za-z])","[\\1\\u\\1]"),
      null())

| eval combined = mvjoin(mvfilter(len(mv)>0, mvappend(host_clean, ip_clean, cloud_clean, user_clean)), "|")

| eval regex_output = "/.*(" . combined . ").*/"

| table regex_output
