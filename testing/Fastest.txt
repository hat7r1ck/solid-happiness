`notable`
| eval _entity = trim(lower("$tok_entity$"))
| where risk_object=_entity

| stats 
    max(_time) as last_seen
    min(_time) as first_seen
    dc(rule_title) as detection_count
    values(risk_object) as risk_object
    sum(coalesce(risk_score,0)) as total_risk
    values(owner) as owners
    values(status_label) as statuses
    values(urgency) as urgencies
    values(disposition) as dispositions
    values(coalesce(mc_incident_id, source_guid, orig_sid, orig_rid)) as mc_ids
    by risk_object

| eval last_seen=strftime(last_seen,"%Y-%m-%d %H:%M:%S")
| eval first_seen=strftime(first_seen,"%Y-%m-%d %H:%M:%S")

| eval mc_ids = mvjoin(mvsort(mc_ids), ", ")
| eval owners = mvjoin(mvsort(owners), ", ")
| eval statuses = mvjoin(mvsort(statuses), ", ")
| eval urgencies = mvjoin(mvsort(urgencies), ", ")
| eval dispositions = mvjoin(mvsort(dispositions), ", ")

| rename
    risk_object as "Risk Object",
    detection_count as "Detection Count",
    total_risk as "Total Risk",
    mc_ids as "MC Incident IDs",
    dispositions as "Dispositions"

| fields last_seen first_seen "Risk Object" "MC Incident IDs" "Detection Count" "Total Risk" owners statuses urgencies "Dispositions"





`notable`
| eval _entity = trim(lower("$tok_entity$"))
| where risk_object=_entity

| eval detection_time=strftime(_time,"%Y-%m-%d %H:%M:%S")
| eval case_id=coalesce(mc_incident_id, source_guid, orig_sid, orig_rid)

| table detection_time owner status_label urgency case_id rule_title description risk_score disposition risk_object

| sort - detection_time

| rename
    detection_time as "Detection Time",
    status_label as "Status",
    case_id as "MC Incident ID",
    rule_title as "Rule",
    description as "Rule Description",
    risk_score as "Risk Score",
    disposition as "Disposition",
    risk_object as "Risk Object"




notable
| eval _entity = trim(lower("$tok_entity$"))
| where len(_entity) > 0

| eval _m_user = lower(coalesce(
    user,
    src_user,
    dest_user,
    identity,
    user_name,
    user_normalized,
    user_email,
    user_identity,
    user_first,
    user_last,
    user_nick
))

| eval _m_host = lower(coalesce(
    host,
    hostname,
    dest,
    dvc,
    dest_nt_host,
    src_nt_host,
    ComputerName,
    'alert.target.hostname'
))

| eval _m_ip = coalesce(
    src,
    src_ip,
    dest,
    dest_ip,
    dvc_ip
)

| eval _m_mail = lower(coalesce(
    user_email,
    src_user_email,
    dest_user_email,
    recipient,
    sender
))

| eval _m_dom = lower(coalesce(
    url_domain,
    dest_dns,
    domain,
    domain_base,
    query
))

| eval _m_url = lower(coalesce(
    url,
    uri,
    request,
    uri_path,
    domain_file
))

| eval _m_hash = lower(coalesce(
    file_hash,
    sha1,
    sha256,
    md5
))

| eval _m_risk = lower(coalesce(
    risk_object,
    normalized_risk_object
))

| eval _risk_score = coalesce(
    user_risk_score,
    risk_score,
    src_risk_score,
    dest_risk_score,
    0
)

| eval _is_ip_entity = if(match(_entity, "^(\\d{1,3}\\.){3}\\d{1,3}(\\/\\d{1,2})?$"), 1, 0)

| eval hit = if(
      _m_user = _entity
   OR _m_host = _entity
   OR _m_ip   = _entity
   OR _m_mail = _entity
   OR _m_dom  = _entity
   OR like(_m_url, "%" . _entity . "%")
   OR _m_hash = _entity
   OR _m_risk = _entity
   OR (_is_ip_entity = 1 AND cidrmatch(_entity, tostring(_m_ip))),
   1, 0
)

| where hit = 1


⸻



| stats
    min(_time) as first_seen
    max(_time) as last_seen
    dc(risk_message) as detection_count
    values(owner) as owners
    values(urgency) as urgencies
    by risk_object

| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S")
| eval last_seen  = strftime(last_seen,  "%Y-%m-%d %H:%M:%S")

| eval owners    = mvjoin(mvindex(mvsort(owners),0,4), ", ")
| eval urgencies = mvjoin(mvindex(mvsort(urgencies),0,4), ", ")

| sort - last_seen

| rename risk_object    AS "Risk Object",
         detection_count AS "Detection Count"

| fields last_seen first_seen "Risk Object" "Detection Count" owners urgencies



⸻


| eval detection_time = _time
| eval rule_name        = coalesce(risk_message, rule_title, search_name)
| eval rule_description = description

| table detection_time rule_name rule_description source_guid owner status_label urgency

| eval detection_time = strftime(detection_time, "%Y-%m-%d %H:%M:%S")

| sort - detection_time

| rename detection_time   AS "Detection Time",
         owner            AS "Owner",
         status_label     AS "Status",
         urgency          AS "Urgency",
         source_guid      AS "MC Incident ID",
         rule_name        AS "Rule",
         rule_description AS "Rule Description"

| fields "Detection Time" "Owner" "Status" "Urgency" "MC Incident ID" "Rule" "Rule Description"

