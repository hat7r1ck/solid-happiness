let
    // CONFIG: Update this path to your actual folder
    SourcePath = "C:\Users\Morgan\Downloads\Raw_Data",
    Source = Folder.Files(SourcePath),

    // 1. FILTER to Excel files only
    #"Filtered Rows" = Table.SelectRows(Source, each ([Extension] = ".xlsx") and not Text.StartsWith([Name], "~$")),

    // --- SMART SHEET SELECTION FUNCTION ---
    GetLastSheet = (BinaryContent) =>
        let
            WorkbookContent = Excel.Workbook(BinaryContent),
            
            // Filter to only real Sheets (ignores Tables/Ranges)
            OnlySheets = Table.SelectRows(WorkbookContent, each [Kind] = "Sheet"),
            
            // SAFETY FILTER: Remove common "Junk" tabs from the bottom of the list
            // This ensures we don't accidentally grab a "Notes" tab if it's the last one.
            RemoveJunkTabs = Table.SelectRows(OnlySheets, each not List.Contains({"Summary", "Notes", "Instructions", "Cover"}, [Name])),
            
            // Grabs the last remaining sheet
            TargetSheetRecord = Table.Last(RemoveJunkTabs),
            TargetSheetData = TargetSheetRecord[Data],
            TargetSheetName = TargetSheetRecord[Name], // Capture name for Audit
            
            // Promote Headers (assumes Row 1 is header)
            PromoteHeaders = Table.PromoteHeaders(TargetSheetData, [PromoteAllScalars=true]),
            
            // Tag the data with the Tab Name so you can Audit it later
            AddSourceMeta = Table.AddColumn(PromoteHeaders, "Source_Tab_Used", each TargetSheetName)
        in
            AddSourceMeta,

    // Apply the function to every file
    #"Added Custom" = Table.AddColumn(#"Filtered Rows", "CustomContent", each GetLastSheet([Content])),
    
    // --- DYNAMIC EXPANSION ---
    // Scans ALL files to find EVERY column header exists. Prevents "Missing Column" errors.
    AllColumnNames = List.Distinct(List.Combine(List.Transform(#"Added Custom"[CustomContent], each Table.ColumnNames(_)))),
    #"Expanded CustomContent" = Table.ExpandTableColumn(#"Added Custom", "CustomContent", AllColumnNames),

    // 2. RENAMING (Standardize - Add any other weird ones you see here)
    #"Renamed Columns" = Table.RenameColumns(#"Expanded CustomContent",{
        {"Time to Ack", "MTTA"}, {"Time to Process", "MTTP"}, 
        {"Alert Count", "Volume"}, {"Total Cases", "Volume"},
        {"Tier", "Tier"}, 
        {"Created", "Date"}, {"Log Date", "Date"}, {"Timestamp", "Date"}, {"Date Created", "Date"}
    }, MissingField.Ignore),

    // 3. THE "TITANIUM" DATE FIX (Final Version)
    // Handles: ISO, Text, Timezones, AND Excel Serial Numbers
    #"Fix Date Format" = Table.TransformColumns(#"Renamed Columns",{
        {"Date", each 
            // CASE 1: Already correct types
            if Value.Is(_, type date) then _ 
            else if Value.Is(_, type datetime) then DateTime.Date(_)
            else if Value.Is(_, type datetimezone) then DateTime.Date(DateTimeZone.RemoveZone(_))
            
            // CASE 2: Excel Serial Numbers (e.g., 45302)
            else if Value.Is(_, type number) then Date.From(_)
            
            // CASE 3: Text Parsing (The hard part)
            else 
                let
                    str = Text.From(_),
                    // Check if it's ISO (Has a 'T' and a Zone?) -> Try DateTimeZone parsing
                    attemptZone = try DateTime.Date(DateTimeZone.RemoveZone(DateTimeZone.From(str))) otherwise null,
                    
                    // If that fails, clean the string: Replace 'T' with space, split by space, take the first part
                    cleanStr = Text.SplitAny(Text.Replace(str, "T", " "), " "){0},
                    attemptDate = try Date.From(cleanStr) otherwise null
                in
                    if attemptZone <> null then attemptZone 
                    else if attemptDate <> null then attemptDate 
                    else null, // Last resort: it's truly garbage
            type date}
    }),

    // 4. CUT THE FAT
    // Filter out rows where Date is null (usually footer totals or blank rows)
    #"Filtered Rows1" = Table.SelectRows(#"Fix Date Format", each [Date] <> null),
    
    // Deduplicate the entire table
    #"Removed Duplicates" = Table.Distinct(#"Filtered Rows1"),
    
    // Ensure Key Metrics are Numbers (Prevents "Text stored as Number" errors)
    #"Final Types" = Table.TransformColumnTypes(#"Removed Duplicates",{
        {"Volume", Int64.Type}, 
        {"MTTA", type number}, 
        {"MTTP", type number},
        {"Staffing", Int64.Type}
    })
in
    #"Final Types"

