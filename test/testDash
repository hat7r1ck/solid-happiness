
1. Base entity filter pattern (use in Search first)

`notable`
| eval _entity = trim(lower("k2b54i"))   /* put your test entity here */
| where len(_entity) > 0

| eval _m_user = lower(coalesce(user, src_user, dest_user, identity, user_name))
| eval _m_host = lower(coalesce(host, hostname, dest, dvc, dest_nt_host, src_nt_host))
| eval _m_ip   = coalesce(src, src_ip, dest, dest_ip, dvc_ip)
| eval _m_mail = lower(coalesce(user_email, src_user_email, dest_user_email, recipient, sender))
| eval _m_dom  = lower(coalesce(url_domain, dest_dns, domain, query))
| eval _m_url  = lower(coalesce(url, uri, request))
| eval _m_hash = lower(coalesce(file_hash, sha256, sha1, md5))
| eval _m_risk = lower(risk_object)

| eval _is_ip_entity = if(match(_entity, "^(\\d{1,3}\\.){3}\\d{1,3}(\\/\\d{1,2})?$"), 1, 0)

| eval hit = if(
      _m_user = _entity OR
      _m_host = _entity OR
      _m_ip   = _entity OR
      _m_mail = _entity OR
      _m_dom  = _entity OR
      like(_m_url, "%" + _entity + "%") OR
      _m_hash = _entity OR
      _m_risk = _entity OR
      (_is_ip_entity = 1 AND cidrmatch(_entity, tostring(_m_ip))),
      1, 0
  )

| where hit = 1

Use this as your “golden” filter. When you are happy with it in Search, swap "k2b54i" for "$tok_entity$" in Studio.

`notable`
| eval _entity = trim(lower("$tok_entity$"))
| where len(_entity) > 0

| eval _m_user = lower(coalesce(user, src_user, dest_user, identity, user_name))
| eval _m_host = lower(coalesce(host, hostname, dest, dvc, dest_nt_host, src_nt_host))
| eval _m_ip   = coalesce(src, src_ip, dest, dest_ip, dvc_ip)
| eval _m_mail = lower(coalesce(user_email, src_user_email, dest_user_email, recipient, sender))
| eval _m_dom  = lower(coalesce(url_domain, dest_dns, domain, query))
| eval _m_url  = lower(coalesce(url, uri, request))
| eval _m_hash = lower(coalesce(file_hash, sha256, sha1, md5))
| eval _m_risk = lower(risk_object)

| eval _is_ip_entity = if(match(_entity, "^(\\d{1,3}\\.){3}\\d{1,3}(\\/\\d{1,2})?$"), 1, 0)

| eval hit = if(
      _m_user = _entity OR
      _m_host = _entity OR
      _m_ip   = _entity OR
      _m_mail = _entity OR
      _m_dom  = _entity OR
      like(_m_url, "%" + _entity + "%") OR
      _m_hash = _entity OR
      _m_risk = _entity OR
      (_is_ip_entity = 1 AND cidrmatch(_entity, tostring(_m_ip))),
      1, 0
  )

| where hit = 1

| stats min(_time) as first_seen
        max(_time) as last_seen
        dc(rule_title) as detections
        values(rule_title) as rules
        sum(coalesce(risk_score,0)) as total_risk
        values(owner) as owners
        values(status_label) as statuses
        values(urgency) as urgencies
        values(coalesce(mc_incident_id, notable_xref_id, orig_sid, orig_rid)) as mc_ids
        by risk_object

| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M:%S")
| eval last_seen  = strftime(last_seen,  "%Y-%m-%d %H:%M:%S")

| eval rules     = mvjoin(mvindex(mvsort(rules),0,4), ", ")
| eval owners    = mvjoin(mvindex(mvsort(owners),0,4), ", ")
| eval statuses  = mvjoin(mvindex(mvsort(statuses),0,4), ", ")
| eval urgencies = mvjoin(mvindex(mvsort(urgencies),0,4), ", ")
| eval mc_ids    = mvjoin(mvindex(mvsort(mc_ids),0,4), ", ")

| sort - last_seen

| rename risk_object as "Risk Object",
         mc_ids      as "MC Incident IDs",
         total_risk  as "Total Risk",
         detections  as "Detection Count"

| fields last_seen first_seen "Risk Object" "MC Incident IDs" "Detection Count" "Total Risk" rules owners statuses urgencies

3.1

`notable`
| eval _entity = trim(lower("k2b54i"))    /* put your test entity here */
| where len(_entity) > 0

| eval _m_user = lower(coalesce(user, src_user, dest_user, identity, user_name))
| eval _m_host = lower(coalesce(host, hostname, dest, dvc, dest_nt_host, src_nt_host))
| eval _m_ip   = coalesce(src, src_ip, dest, dest_ip, dvc_ip)
| eval _m_mail = lower(coalesce(user_email, src_user_email, dest_user_email, recipient, sender))
| eval _m_dom  = lower(coalesce(url_domain, dest_dns, domain, query))
| eval _m_url  = lower(coalesce(url, uri, request))
| eval _m_hash = lower(coalesce(file_hash, sha256, sha1, md5))
| eval _m_risk = lower(risk_object)

| eval user_match  = if(_m_user = _entity, 1, 0)
| eval host_match  = if(_m_host = _entity, 1, 0)
| eval ip_match    = if(_m_ip   = _entity, 1, 0)
| eval mail_match  = if(_m_mail = _entity, 1, 0)
| eval dom_match   = if(_m_dom  = _entity, 1, 0)
| eval url_match   = if(like(_m_url, "%" + _entity + "%"), 1, 0)
| eval hash_match  = if(_m_hash = _entity, 1, 0)
| eval risk_match  = if(_m_risk = _entity, 1, 0)

| stats sum(user_match)  as user_hits,
        sum(host_match)  as host_hits,
        sum(ip_match)    as ip_hits,
        sum(mail_match)  as mail_hits,
        sum(dom_match)   as domain_hits,
        sum(url_match)   as url_hits,
        sum(hash_match)  as hash_hits,
        sum(risk_match)  as risk_hits

`notable`
| search    /* replace with your entity, this uses Splunk's raw/field search */

| fieldsummary
| table field distinct_count values
| sort field
