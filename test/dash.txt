<dashboard>
  <label>MITRE Investigation Workspace</label>
  <description>MITRE investigation dashboard for entity analysis</description>
  
  <fieldset submitButton="false">
    <input type="text" token="tok_entity">
      <label>Entity (host, user, IP)</label>
      <default></default>
    </input>
    
    <input type="time" token="tok_timerange">
      <label>Time Range</label>
      <default>
        <earliest>-24h</earliest>
        <latest>now</latest>
      </default>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <title>MITRE-Mapped Rules and Alerts for Entity</title>
      <table>
        <search>
          <query>from datamodel:"Risk"."All_Risk" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, "\s*-\s*", "-") | eval _parts = split(_norm, "-") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), "-"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rex field=_norm "^[^-]+-\s*(?&lt;rule_name_alt&gt;.*?)\s*-[^-]+$" | eval rule_name = trim(coalesce(rule_name, rule_name_alt, _norm)) | rename rule_name as "Rule Name", annotations.mitre_attack.mitre_tactic_id as "MITRE Tactic ID", annotations.mitre_attack.mitre_tactic as "MITRE Tactic", annotations.mitre_attack.mitre_technique as "MITRE Technique", annotations.mitre_attack.mitre_technique_id as "MITRE Technique ID", calculated_risk_score as "Risk Score", annotations.wf_data_source as "Data Source" | table "Rule Name", "MITRE Tactic ID", "MITRE Tactic", "MITRE Technique", "MITRE Technique ID", "Risk Score", "Data Source", _time | sort -_time</query>
          <earliest>$tok_timerange.earliest$</earliest>
          <latest>$tok_timerange.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Lookup Table Files</title>
      <table>
        <search>
          <query>| rest /services/data/lookup-table-files | table title, author, updated | rename title as "Lookup File", author as "Modified By", updated as "Last Updated" | sort -"Last Updated"</query>
          <earliest>-1d</earliest>
          <latest>now</latest>
        </search>
        <option name="wrap">false</option>
        <option name="rowNumbers">false</option>
      </table>
    </panel>
    
    <panel>
      <title>Risk Score Timeline</title>
      <chart>
        <search>
          <query>from datamodel:"Risk"."All_Risk" | search annotations=*ctcf* $tok_entity$ | rename calculated_risk_score as "Risk Score" | bin _time span=1h | stats avg("Risk Score") as avg_risk by _time | sort _time</query>
          <earliest>$tok_timerange.earliest$</earliest>
          <latest>$tok_timerange.latest$</latest>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Average Risk Score</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Raw Contributing Events</title>
      <event>
        <search>
          <query>from datamodel:"Risk"."All_Risk" | search annotations=*ctcf* $tok_entity$ | head 50 | sort -_time</query>
          <earliest>$tok_timerange.earliest$</earliest>
          <latest>$tok_timerange.latest$</latest>
        </search>
        <option name="wrap">true</option>
        <option name="maxLines">10</option>
      </event>
    </panel>
  </row>
  
</dashboard>
