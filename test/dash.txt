{
  "title": "MITRE Investigation Workspace",
  "description": "SOC dashboard for MITRE-mapped rules and entity investigations",
  "inputs": {
    "input_entity": {
      "type": "input.text",
      "options": {
        "token": "tok_entity",
        "defaultValue": ""
      },
      "title": "Entity (host, user, IP)"
    },
    "input_global_trp": {
      "type": "input.timerange",
      "options": {
        "defaultValue": "-24h@h,now",
        "token": "global_time"
      },
      "title": "Global Time Range"
    }
  },
  "defaults": {
    "dataSources": {
      "ds.search": {
        "options": {
          "queryParameters": {
            "earliest": "$global_time.earliest$",
            "latest": "$global_time.latest$"
          }
        }
      }
    }
  },
  "visualizations": {
    "viz_mitre_rules": {
      "type": "splunk.table",
      "title": "MITRE-Mapped Rules and Alerts for Entity",
      "options": {
        "wrap": true,
        "showRowNumbers": true
      },
      "dataSources": {
        "primary": "ds_main_search"
      }
    },
    "viz_lookup_files": {
      "type": "splunk.table",
      "title": "Lookup Table Files",
      "options": {
        "wrap": false,
        "showRowNumbers": false
      },
      "dataSources": {
        "primary": "ds_lookup_files"
      }
    },
    "viz_risk_timeline": {
      "type": "splunk.line",
      "title": "Risk Score Timeline",
      "options": {
        "showMarkers": true
      },
      "dataSources": {
        "primary": "ds_timeline"
      }
    },
    "viz_raw_events": {
      "type": "splunk.events",
      "title": "Raw Contributing Events",
      "options": {
        "wrap": true,
        "maxLines": 10
      },
      "dataSources": {
        "primary": "ds_raw_events"
      }
    }
  },
  "dataSources": {
    "ds_main_search": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rex field=_norm \"^[^-]+-\\s*(?<rule_name_alt>.*?)\\s*-[^-]+$\" | eval rule_name = trim(coalesce(rule_name, rule_name_alt, _norm)) | rename rule_name as \"Rule Name\", annotations.mitre_attack.mitre_tactic_id as \"MITRE Tactic ID\", annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", annotations.mitre_attack.mitre_technique as \"MITRE Technique\", annotations.mitre_attack.mitre_technique_id as \"MITRE Technique ID\", calculated_risk_score as \"Risk Score\", annotations.wf_data_source as \"Data Source\" | table \"Rule Name\", \"MITRE Tactic ID\", \"MITRE Tactic\", \"MITRE Technique\", \"MITRE Technique ID\", \"Risk Score\", \"Data Source\", _time | sort -_time"
      },
      "name": "Main MITRE Search"
    },
    "ds_lookup_files": {
      "type": "ds.search",
      "options": {
        "query": "| rest /services/data/lookup-table-files | table title, author, updated | rename title as \"Lookup File\", author as \"Modified By\", updated as \"Last Updated\" | sort -\"Last Updated\""
      },
      "name": "Lookup Files"
    },
    "ds_timeline": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | rename calculated_risk_score as \"Risk Score\" | bin _time span=1h | stats avg(\"Risk Score\") as avg_risk by _time | sort _time"
      },
      "name": "Risk Timeline"
    },
    "ds_raw_events": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | head 50 | sort -_time"
      },
      "name": "Raw Events"
    }
  },
  "layout": {
    "globalInputs": [
      "input_entity",
      "input_global_trp"
    ],
    "layoutDefinitions": {
      "layout_1": {
        "options": {
          "height": 960,
          "width": 1440
        },
        "structure": [
          {
            "item": "viz_mitre_rules",
            "type": "block",
            "position": {
              "x": 0,
              "y": 0,
              "w": 8,
              "h": 6
            }
          },
          {
            "item": "viz_lookup_files",
            "type": "block",
            "position": {
              "x": 8,
              "y": 0,
              "w": 4,
              "h": 3
            }
          },
          {
            "item": "viz_risk_timeline",
            "type": "block",
            "position": {
              "x": 8,
              "y": 3,
              "w": 4,
              "h": 3
            }
          },
          {
            "item": "viz_raw_events",
            "type": "block",
            "position": {
              "x": 0,
              "y": 6,
              "w": 12,
              "h": 4
            }
          }
        ],
        "type": "grid"
      }
    },
    "options": {},
    "tabs": {
      "items": [
        {
          "label": "Main Dashboard",
          "layoutId": "layout_1"
        }
      ]
    }
  }
}
