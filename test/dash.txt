{
  "title": "MITRE Investigation Workspace",
  "inputs": {
    "input_entity": {
      "type": "input.text",
      "options": {
        "token": "tok_entity"
      },
      "title": "Entity"
    },
    "input_global_trp": {
      "type": "input.timerange",
      "options": {
        "defaultValue": "-24h@h,now",
        "token": "global_time"
      },
      "title": "Global Time Range"
    }
  },
  "defaults": {
    "dataSources": {
      "ds.search": {
        "options": {
          "queryParameters": {
            "earliest": "$global_time.earliest$",
            "latest": "$global_time.latest$"
          }
        }
      }
    }
  },
  "visualizations": {
    "viz_mitre_rules": {
      "type": "splunk.table",
      "title": "MITRE-Mapped Rules and Alerts for Entity",
      "dataSources": {
        "primary": "ds_main_search"
      }
    },
    "viz_lookup_files": {
      "type": "splunk.table",
      "title": "Lookup Table Files",
      "dataSources": {
        "primary": "ds_lookup_files"
      }
    },
    "viz_risk_timeline": {
      "type": "splunk.line",
      "title": "Risk Score Timeline",
      "dataSources": {
        "primary": "ds_timeline"
      }
    },
    "viz_raw_events": {
      "type": "splunk.events",
      "title": "Raw Contributing Events",
      "dataSources": {
        "primary": "ds_raw_events"
      }
    },
    "viz_mitre_pie": {
      "type": "splunk.pie",
      "title": "MITRE Tactic Distribution",
      "dataSources": {
        "primary": "ds_pie_chart"
      }
    },
    "viz_top_entities": {
      "type": "splunk.table",
      "title": "Top Risk Entities",
      "dataSources": {
        "primary": "ds_top_entities"
      }
    }
  },
  "dataSources": {
    "ds_main_search": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rex field=_norm \"^[^-]+-\\s*(?<rule_name_alt>.*?)\\s*-[^-]+$\" | eval rule_name = trim(coalesce(rule_name, rule_name_alt, _norm)) | rename rule_name as \"Rule Name\", annotations.mitre_attack.mitre_tactic_id as \"MITRE Tactic ID\", annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", annotations.mitre_attack.mitre_technique as \"MITRE Technique\", annotations.mitre_attack.mitre_technique_id as \"MITRE Technique ID\", calculated_risk_score as \"Risk Score\", annotations.wf_data_source as \"Data Source\" | table \"Rule Name\", \"MITRE Tactic ID\", \"MITRE Tactic\", \"MITRE Technique\", \"MITRE Technique ID\", \"Risk Score\", \"Data Source\", _time | sort -_time"
      }
    },
    "ds_lookup_files": {
      "type": "ds.search",
      "options": {
        "query": "| rest /services/data/lookup-table-files | table title, author, updated | rename title as \"Lookup File\", author as \"Modified By\", updated as \"Last Updated\" | sort -\"Last Updated\""
      }
    },
    "ds_timeline": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | rename calculated_risk_score as \"Risk Score\" | bin _time span=1h | stats avg(\"Risk Score\") as avg_risk by _time | sort _time"
      }
    },
    "ds_raw_events": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | head 50 | sort -_time"
      }
    },
    "ds_pie_chart": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\" | where isnotnull(\"MITRE Tactic\") | stats count by \"MITRE Tactic\" | sort -count"
      }
    },
    "ds_top_entities": {
      "type": "ds.search",
      "options": {
        "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* | rename calculated_risk_score as \"Risk Score\", annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\" | stats sum(\"Risk Score\") as total_risk, count as rule_count by risk_object | eval total_risk=round(total_risk, 1) | sort -total_risk | head 20 | rename risk_object as \"Entity\", total_risk as \"Total Risk\", rule_count as \"Rule Count\""
      }
    }
  },
  "layout": {
    "globalInputs": ["input_entity", "input_global_trp"],
    "type": "absolute",
    "options": {
      "width": 1440,
      "height": 1200
    },
    "structure": [
      {
        "item": "viz_mitre_rules",
        "type": "block",
        "position": {
          "x": 20,
          "y": 20,
          "w": 800,
          "h": 400
        }
      },
      {
        "item": "viz_mitre_pie",
        "type": "block",
        "position": {
          "x": 840,
          "y": 20,
          "w": 300,
          "h": 200
        }
      },
      {
        "item": "viz_lookup_files",
        "type": "block",
        "position": {
          "x": 1160,
          "y": 20,
          "w": 260,
          "h": 400
        }
      },
      {
        "item": "viz_risk_timeline",
        "type": "block",
        "position": {
          "x": 840,
          "y": 240,
          "w": 300,
          "h": 180
        }
      },
      {
        "item": "viz_top_entities",
        "type": "block",
        "position": {
          "x": 20,
          "y": 440,
          "w": 400,
          "h": 300
        }
      },
      {
        "item": "viz_raw_events",
        "type": "block",
        "position": {
          "x": 440,
          "y": 440,
          "w": 980,
          "h": 300
        }
      }
    ]
  }
}
