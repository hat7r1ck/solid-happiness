{
  "dashboard": {
    "title": "MITRE Investigation Workspace",
    "description": "Production-ready SOC dashboard for MITRE-mapped rules, entity investigations, exclusion list browser, and raw event analysis",
    "defaults": {
      "theme": "dark"
    },
    "inputs": {
      "tok_entity": {
        "type": "text",
        "title": "Entity (host, user, IP, username)",
        "defaultValue": "",
        "description": "Enter hostname, username, IP address, or other entity from alert/case"
      },
      "tok_mitre_tactic": {
        "type": "dropdown",
        "title": "MITRE Tactic Filter (optional)",
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rex field=_norm \"^[^-]+-\\s*(?<rule_name_alt>.*?)\\s*-[^-]+$\" | eval rule_name = trim(coalesce(rule_name, rule_name_alt, _norm)) | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\" | stats count by \"MITRE Tactic\" | where isnotnull(\"MITRE Tactic\") | sort \"MITRE Tactic\"",
          "earliest_time": "-7d",
          "latest_time": "now"
        },
        "fieldForLabel": "MITRE Tactic",
        "fieldForValue": "MITRE Tactic",
        "allowCustomValues": false,
        "defaultValue": ""
      },
      "tok_timerange": {
        "type": "time",
        "title": "Time Range",
        "defaultValue": {
          "earliest_time": "-24h",
          "latest_time": "now"
        }
      }
    },
    "visualizations": {
      "viz_rule_summary": {
        "type": "table",
        "title": "MITRE-Mapped Rules and Alerts",
        "description": "All triggered rules for the specified entity with MITRE ATT&CK mapping and risk scores",
        "options": {
          "wrap": true,
          "showRowNumbers": true,
          "drilldown": "row"
        },
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rex field=_norm \"^[^-]+-\\s*(?<rule_name_alt>.*?)\\s*-[^-]+$\" | eval rule_name = trim(coalesce(rule_name, rule_name_alt, _norm)) | rename rule_name as \"Rule Name\", annotations.mitre_attack.mitre_tactic_id as \"MITRE Tactic ID\", annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", annotations.mitre_attack.mitre_technique as \"MITRE Technique\", annotations.mitre_attack.mitre_technique_id as \"MITRE Technique ID\", calculated_risk_score as \"Risk Score\", annotations.wf_data_source as \"Data Source\" | search \"MITRE Tactic\"=\"$tok_mitre_tactic$\" | table \"Rule Name\", \"MITRE Tactic ID\", \"MITRE Tactic\", \"MITRE Technique\", \"MITRE Technique ID\", \"Risk Score\", \"Data Source\", _time | sort -_time",
          "earliest_time": "$tok_timerange.earliest$",
          "latest_time": "$tok_timerange.latest$"
        }
      },
      
      "viz_mitre_breakdown": {
        "type": "pie",
        "title": "MITRE Tactic Distribution",
        "description": "Visual breakdown of MITRE tactics for current entity and timeframe",
        "options": {
          "showPercent": true,
          "showLegend": true
        },
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\" | search \"MITRE Tactic\"=\"$tok_mitre_tactic$\" | where isnotnull(\"MITRE Tactic\") | stats count by \"MITRE Tactic\" | sort -count",
          "earliest_time": "$tok_timerange.earliest$",
          "latest_time": "$tok_timerange.latest$"
        }
      },

      "viz_exclusion_browser": {
        "type": "table",
        "title": "Available Exclusion Lists",
        "description": "Browse all correlation rule exclusion lists for investigation and tuning",
        "options": {
          "wrap": true,
          "showRowNumbers": false,
          "drilldown": "row"
        },
        "search": {
          "query": "| rest /services/data/lookup-table-files | eval is_exclusion=if(like(title,\"%Exclusion%\") OR like(title,\"%exclusion%\") OR like(title,\"%Useragent%\"), 1, 0) | search is_exclusion=1 | eval file_size_mb=round(file_size/1024/1024, 2) | table title, author, updated, file_size_mb | rename title as \"Lookup File\", author as \"Modified By\", updated as \"Last Updated\", file_size_mb as \"Size (MB)\" | sort -\"Last Updated\"",
          "earliest_time": "-1d",
          "latest_time": "now"
        }
      },

      "viz_risk_timeline": {
        "type": "line",
        "title": "Risk Score Timeline",
        "description": "Risk event frequency and scores over time for entity investigation",
        "options": {
          "showMarkers": true,
          "showLegend": true
        },
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", calculated_risk_score as \"Risk Score\" | search \"MITRE Tactic\"=\"$tok_mitre_tactic$\" | bin _time span=1h | stats avg(\"Risk Score\") as avg_risk, count as event_count by _time | eval avg_risk=round(avg_risk, 1) | sort _time",
          "earliest_time": "$tok_timerange.earliest$",
          "latest_time": "$tok_timerange.latest$"
        }
      },

      "viz_top_entities": {
        "type": "table",
        "title": "Top Risk Entities (Context)",
        "description": "Other high-risk entities in the same timeframe for correlation analysis",
        "options": {
          "wrap": false,
          "showRowNumbers": true
        },
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", calculated_risk_score as \"Risk Score\" | search \"MITRE Tactic\"=\"$tok_mitre_tactic$\" | stats sum(\"Risk Score\") as total_risk, count as rule_count, values(\"MITRE Tactic\") as tactics by risk_object | eval total_risk=round(total_risk, 1) | sort -total_risk | head 20 | rename risk_object as \"Entity\", total_risk as \"Total Risk\", rule_count as \"Rule Count\", tactics as \"MITRE Tactics\"",
          "earliest_time": "$tok_timerange.earliest$",
          "latest_time": "$tok_timerange.latest$"
        }
      },

      "viz_raw_events": {
        "type": "events",
        "title": "Raw Contributing Events",
        "description": "Drill-down view of raw log events contributing to risk for the specified entity",
        "options": {
          "wrap": true,
          "showRowNumbers": true,
          "maxLines": 10
        },
        "search": {
          "query": "from datamodel:\"Risk\".\"All_Risk\" | search annotations=*ctcf* $tok_entity$ | eval _norm = replace(search_name, \"\\s*-\\s*\", \"-\") | eval _parts = split(_norm, \"-\") | eval rule_name = case(mvcount(_parts) > 3, mvjoin(mvindex(_parts, 1, mvcount(_parts) - 2), \"-\"), mvcount(_parts) == 2, mvindex(_parts, 1), true(), null()) | rename annotations.mitre_attack.mitre_tactic as \"MITRE Tactic\", calculated_risk_score as \"Risk Score\" | search \"MITRE Tactic\"=\"$tok_mitre_tactic$\" | head 50 | sort -_time",
          "earliest_time": "$tok_timerange.earliest$",
          "latest_time": "$tok_timerange.latest$"
        }
      }
    },
    "layout": {
      "type": "grid",
      "options": {
        "width": 1440,
        "height": 1200,
        "submitButton": false
      },
      "structure": [
        {
          "item": "viz_rule_summary",
          "type": "viz",
          "position": {"x": 0, "y": 0, "w": 8, "h": 6}
        },
        {
          "item": "viz_mitre_breakdown",
          "type": "viz", 
          "position": {"x": 8, "y": 0, "w": 4, "h": 3}
        },
        {
          "item": "viz_risk_timeline",
          "type": "viz",
          "position": {"x": 8, "y": 3, "w": 4, "h": 3}
        },
        {
          "item": "viz_exclusion_browser",
          "type": "viz",
          "position": {"x": 0, "y": 6, "w": 6, "h": 4}
        },
        {
          "item": "viz_top_entities",
          "type": "viz",
          "position": {"x": 6, "y": 6, "w": 3, "h": 4}
        },
        {
          "item": "viz_raw_events",
          "type": "viz",
          "position": {"x": 9, "y": 6, "w": 3, "h": 4}
        }
      ]
    }
  }
}
