index=akami earliest=-14d@d latest=now
| bin _time span=1s
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| stats count as events_per_second 
    dc(attackData.clientIP) as unique_source_ips 
    dc(user_agent) as unique_user_agents
    values(attackData.clientIP) as source_ips 
    values(user_agent) as user_agents
    values(geo.asn) as source_asn
    values(geo.city) as source_cities
    values(geo.country) as source_countries
    values(httpMessage.method) as http_methods
    values(httpMessage.host) as targeted_hosts
    values(httpMessage.path) as targeted_paths
    values(httpMessage.status) as http_status_codes
    values(attackData.rules{}.id) as attack_rule_ids
    values(attackData.rules{}.message) as attack_rule_messages
    sum(httpMessage.bytes) as total_bytes
    by _time
| where events_per_second > 1000000
| eval events_per_second_formatted=tostring(events_per_second, "commas")
| eval total_gb=round(total_bytes/1024/1024/1024, 2)
| eval attack_severity=case(
    events_per_second >= 7000000, "ðŸ”´ CRITICAL - 7M+ EPS",
    events_per_second >= 5000000, "ðŸŸ  HIGH - 5M+ EPS",
    events_per_second >= 1000000, "ðŸŸ¡ ELEVATED - 1M+ EPS")
| eval time_of_attack=strftime(_time, "%Y-%m-%d %H:%M:%S %Z")
| eval source_ips_top10=mvindex(source_ips, 0, 9)
| eval source_ips_display=if(mvcount(source_ips) > 10, mvjoin(source_ips_top10, ", ") + " ... [+" + tostring(mvcount(source_ips) - 10, "commas") + " more IPs]", mvjoin(source_ips, ", "))
| eval user_agents_top5=mvindex(user_agents, 0, 4)
| eval user_agents_display=if(mvcount(user_agents) > 5, mvjoin(user_agents_top5, " | ") + " ... [+" + tostring(mvcount(user_agents) - 5, "commas") + " more]", mvjoin(user_agents, " | "))
| eval attack_pattern=case(
    unique_source_ips < 100 AND events_per_second > 5000000, "Concentrated Attack (Few IPs, High Volume)",
    unique_source_ips > 10000, "Distributed Botnet (Many IPs)",
    unique_user_agents < 5, "Scripted/Automated Attack",
    1=1, "Mixed Pattern")
| table time_of_attack, events_per_second_formatted, attack_severity, attack_pattern, unique_source_ips, source_ips_display, unique_user_agents, user_agents_display, source_countries, source_cities, source_asn, http_methods, targeted_hosts, targeted_paths, http_status_codes, attack_rule_ids, attack_rule_messages, total_gb
| sort -events_per_second_formatted
| rename time_of_attack as "Date/Time", events_per_second_formatted as "Events/Sec", attack_severity as "Severity", attack_pattern as "Attack Pattern", unique_source_ips as "Unique IPs", source_ips_display as "Top Source IPs (Sample)", unique_user_agents as "Unique UAs", user_agents_display as "Top User Agents (Sample)", source_countries as "Countries", source_cities as "Cities", source_asn as "ASN", http_methods as "HTTP Methods", targeted_hosts as "Targeted Hosts", targeted_paths as "Targeted Paths", http_status_codes as "Status Codes", attack_rule_ids as "WAF Rule IDs", attack_rule_messages as "WAF Rule Messages", total_gb as "Total GB"
