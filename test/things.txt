index=akami earliest=-14d@d latest=now
| bin _time span=1s
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| stats count as events_per_second 
    dc(attackData.clientIP) as unique_source_ips 
    dc(user_agent) as unique_user_agents
    values(attackData.clientIP) as source_ips 
    values(user_agent) as user_agents
    values(geo.asn) as source_asn
    values(geo.city) as source_cities
    values(geo.country) as source_countries
    values(httpMessage.method) as http_methods
    values(httpMessage.host) as targeted_hosts
    values(httpMessage.path) as targeted_paths
    values(httpMessage.status) as http_status_codes
    values(attackData.rules{}.id) as attack_rule_ids
    values(attackData.rules{}.message) as attack_rule_messages
    sum(httpMessage.bytes) as total_bytes
    by _time
| where events_per_second > 1000000
| eval events_per_second_formatted=tostring(events_per_second, "commas")
| eval total_gb=round(total_bytes/1024/1024/1024, 2)
| eval attack_severity=case(
    events_per_second >= 7000000, "ðŸ”´ CRITICAL - 7M+ EPS",
    events_per_second >= 5000000, "ðŸŸ  HIGH - 5M+ EPS",
    events_per_second >= 1000000, "ðŸŸ¡ ELEVATED - 1M+ EPS")
| eval time_of_attack=strftime(_time, "%Y-%m-%d %H:%M:%S %Z")
| eval source_ips_top10=mvindex(source_ips, 0, 9)
| eval source_ips_display=if(mvcount(source_ips) > 10, mvjoin(source_ips_top10, ", ") + " ... [+" + tostring(mvcount(source_ips) - 10, "commas") + " more IPs]", mvjoin(source_ips, ", "))
| eval user_agents_top5=mvindex(user_agents, 0, 4)
| eval user_agents_display=if(mvcount(user_agents) > 5, mvjoin(user_agents_top5, " | ") + " ... [+" + tostring(mvcount(user_agents) - 5, "commas") + " more]", mvjoin(user_agents, " | "))
| eval attack_pattern=case(
    unique_source_ips < 100 AND events_per_second > 5000000, "Concentrated Attack (Few IPs, High Volume)",
    unique_source_ips > 10000, "Distributed Botnet (Many IPs)",
    unique_user_agents < 5, "Scripted/Automated Attack",
    1=1, "Mixed Pattern")
| table time_of_attack, events_per_second_formatted, attack_severity, attack_pattern, unique_source_ips, source_ips_display, unique_user_agents, user_agents_display, source_countries, source_cities, source_asn, http_methods, targeted_hosts, targeted_paths, http_status_codes, attack_rule_ids, attack_rule_messages, total_gb
| sort -events_per_second_formatted
| rename time_of_attack as "Date/Time", events_per_second_formatted as "Events/Sec", attack_severity as "Severity", attack_pattern as "Attack Pattern", unique_source_ips as "Unique IPs", source_ips_display as "Top Source IPs (Sample)", unique_user_agents as "Unique UAs", user_agents_display as "Top User Agents (Sample)", source_countries as "Countries", source_cities as "Cities", source_asn as "ASN", http_methods as "HTTP Methods", targeted_hosts as "Targeted Hosts", targeted_paths as "Targeted Paths", http_status_codes as "Status Codes", attack_rule_ids as "WAF Rule IDs", attack_rule_messages as "WAF Rule Messages", total_gb as "Total GB"




index=akami earliest=-14d@d latest=now
| bin _time span=1s
| stats count as events_per_second 
    dc(attackData.clientIP) as unique_source_ips 
    values(geo.country) as source_countries
    values(httpMessage.method) as http_methods
    values(httpMessage.host) as targeted_hosts
    max(attackData.rules{}.message) as primary_attack_type
    by _time
| where events_per_second > 1000
| eval events_per_second_formatted=tostring(events_per_second, "commas")
| eval attack_severity=case(
    events_per_second >= 1000000, "CRITICAL",
    events_per_second >= 100000, "HIGH",
    events_per_second >= 10000, "MEDIUM",
    events_per_second >= 1000, "LOW",
    1=1, "INFO")
| eval time_of_attack=strftime(_time, "%Y-%m-%d %H:%M:%S UTC")
| eval countries_display=mvindex(source_countries, 0, 4)
| eval countries_summary=if(mvcount(source_countries) > 5, mvjoin(countries_display, ", ") + " (+" + tostring(mvcount(source_countries) - 5, "commas") + " more)", mvjoin(source_countries, ", "))
| eval target_summary=mvindex(targeted_hosts, 0, 2)
| table time_of_attack, events_per_second_formatted, attack_severity, unique_source_ips, countries_summary, primary_attack_type, target_summary
| sort -events_per_second_formatted
| head 50
| rename time_of_attack as "Time (UTC)", events_per_second_formatted as "Events/Sec", attack_severity as "Severity", unique_source_ips as "Source IPs", countries_summary as "Origin Countries", primary_attack_type as "Attack Type", target_summary as "Targets"




index=akami earliest=-14d@d latest=now
| bin _time span=5m
| stats count as events
    dc(attackData.clientIP) as unique_ips
    values(geo.country) as countries
    values(httpMessage.host) as targets
    values(attackData.rules{}.message) as attack_types
    by _time
| streamstats time_window=30m sum(events) as rolling_30min_events current=f
| where events > 100000 OR unique_ips > 10000
| streamstats count as window_count reset_after="(events < 100000)"
| eventstats min(_time) as attack_start, max(_time) as attack_end, sum(events) as total_attack_events, dc(unique_ips) as total_unique_ips, values(countries) as all_countries, values(targets) as all_targets, values(attack_types) as all_attack_types by window_count
| where _time=attack_start
| eval attack_duration_min=round((attack_end - attack_start)/60, 0)
| eval attack_start_time=strftime(attack_start, "%Y-%m-%d %H:%M UTC")
| eval attack_end_time=strftime(attack_end, "%Y-%m-%d %H:%M UTC")
| eval total_events_fmt=tostring(total_attack_events, "commas")
| eval avg_eps=round(total_attack_events / (attack_end - attack_start), 0)
| eval avg_eps_fmt=tostring(avg_eps, "commas")
| eval severity=case(avg_eps >= 1000000, "CRITICAL", avg_eps >= 100000, "HIGH", avg_eps >= 10000, "MEDIUM", 1=1, "LOW")
| eval countries_display=if(mvcount(all_countries) > 10, mvjoin(mvindex(all_countries, 0, 9), ", ") + " (+" + tostring(mvcount(all_countries)-10) + " more)", mvjoin(all_countries, ", "))
| eval targets_display=if(mvcount(all_targets) > 3, mvjoin(mvindex(all_targets, 0, 2), ", ") + " (+" + tostring(mvcount(all_targets)-3) + " more)", mvjoin(all_targets, ", "))
| eval attack_summary=mvjoin(mvindex(all_attack_types, 0, 3), " | ")
| table attack_start_time, attack_end_time, attack_duration_min, total_events_fmt, avg_eps_fmt, severity, total_unique_ips, countries_display, targets_display, attack_summary
| sort - attack_start_time
| rename attack_start_time as "Attack Start", attack_end_time as "Attack End", attack_duration_min as "Duration (min)", total_events_fmt as "Total Events", avg_eps_fmt as "Avg EPS", severity as "Severity", total_unique_ips as "Unique IPs", countries_display as "Origin Countries", targets_display as "Targeted Hosts", attack_summary as "Attack Types"



index=akami earliest=-14d@d latest=now
| bucket _time span=10m
| stats count as events
    dc(attackData.clientIP) as unique_ips
    values(geo.country) as countries
    values(httpMessage.host) as targets
    values(httpMessage.method) as methods
    values(attackData.rules{}.message) as attack_types
    by _time
| sort 0 _time
| streamstats current=f window=1 last(_time) as prev_time
| eval time_gap=(_time - prev_time)
| eval is_new_attack=if(time_gap > 1800 OR isnull(time_gap), 1, 0)
| streamstats sum(is_new_attack) as attack_id
| eventstats 
    min(_time) as attack_start
    max(_time) as attack_end
    sum(events) as total_events
    sum(unique_ips) as total_ips
    values(countries) as all_countries
    values(targets) as all_targets
    values(methods) as all_methods
    values(attack_types) as all_attack_types
    by attack_id
| where _time=attack_start
| eval duration_min=round((attack_end - attack_start)/60, 0)
| eval start_time=strftime(attack_start, "%Y-%m-%d %H:%M UTC")
| eval end_time=strftime(attack_end, "%Y-%m-%d %H:%M UTC")
| eval events_formatted=tostring(total_events, "commas")
| eval ips_formatted=tostring(total_ips, "commas")
| eval avg_eps=round(total_events / ((attack_end - attack_start) + 1), 0)
| eval avg_eps_formatted=tostring(avg_eps, "commas")
| eval severity=case(
    avg_eps >= 1000000, "CRITICAL",
    avg_eps >= 100000, "HIGH", 
    avg_eps >= 10000, "MEDIUM",
    1=1, "LOW")
| eval country_list=if(mvcount(all_countries) > 8, mvjoin(mvindex(all_countries, 0, 7), ", ") + " (+" + tostring(mvcount(all_countries)-8) + " more)", mvjoin(all_countries, ", "))
| eval target_list=if(mvcount(all_targets) > 2, mvjoin(mvindex(all_targets, 0, 1), ", ") + " (+" + tostring(mvcount(all_targets)-2) + " more)", mvjoin(all_targets, ", "))
| eval attack_type_list=mvjoin(mvindex(all_attack_types, 0, 2), " | ")
| table start_time, end_time, duration_min, events_formatted, avg_eps_formatted, severity, ips_formatted, country_list, target_list, attack_type_list
| sort - start_time
| rename 
    start_time as "Attack Start" 
    end_time as "Attack End" 
    duration_min as "Duration (min)" 
    events_formatted as "Total Events" 
    avg_eps_formatted as "Avg EPS" 
    severity as "Severity" 
    ips_formatted as "Unique IPs" 
    country_list as "Countries" 
    target_list as "Targets" 
    attack_type_list as "Attack Types"



index=akami earliest=-14d@d latest=now
| bucket _time span=5m
| stats count as events
    dc(attackData.clientIP) as unique_ips
    values(geo.country) as countries
    values(httpMessage.host) as targets
    values(attackData.rules{}.message) as attack_types
    by _time
| eval eps=round(events/300, 0)
| eval eps_formatted=tostring(eps, "commas")
| eval events_formatted=tostring(events, "commas")
| eval ips_formatted=tostring(unique_ips, "commas")
| eval severity=case(
    eps >= 100000, "CRITICAL",
    eps >= 10000, "HIGH",
    eps >= 1000, "MEDIUM",
    eps >= 100, "LOW",
    1=1, "NORMAL")
| eval time_utc=strftime(_time, "%Y-%m-%d %H:%M UTC")
| eval countries_display=if(mvcount(countries) > 8, mvjoin(mvindex(countries, 0, 7), ", ") + " (+" + tostring(mvcount(countries)-8) + " more)", mvjoin(countries, ", "))
| eval targets_display=if(mvcount(targets) > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(mvcount(targets)-3) + " more)", mvjoin(targets, ", "))
| eval attack_summary=mvjoin(mvindex(attack_types, 0, 2), " | ")
| where eps >= 1000
| table time_utc, events_formatted, eps_formatted, severity, ips_formatted, countries_display, targets_display, attack_summary
| sort - eps
| head 50
| rename time_utc as "Time (UTC)", events_formatted as "Events (5min)", eps_formatted as "Avg EPS", severity as "Severity", ips_formatted as "Unique IPs", countries_display as "Countries", targets_display as "Targets", attack_summary as "Attack Types"




index=akami earliest=-14d@d latest=now
| stats count as total_events
    dc(attackData.clientIP) as unique_ips
    dc(geo.country) as countries
    values(geo.country) as country_list
    values(httpMessage.host) as targeted_hosts
    min(_time) as first_seen
    max(_time) as last_seen
    by attackData.rules{}.message
| eval duration_hours=round((last_seen - first_seen)/3600, 1)
| eval events_fmt=tostring(total_events, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval first_seen_time=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_time=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval severity=case(
    total_events >= 1000000, "CRITICAL",
    total_events >= 100000, "HIGH",
    total_events >= 10000, "MEDIUM",
    1=1, "LOW")
| eval targets=if(mvcount(targeted_hosts) > 3, mvjoin(mvindex(targeted_hosts, 0, 2), ", ") + " (+" + tostring(mvcount(targeted_hosts)-3) + " more)", mvjoin(targeted_hosts, ", "))
| table attackData.rules{}.message, events_fmt, severity, ips_fmt, countries, first_seen_time, last_seen_time, duration_hours, targets
| sort - total_events
| rename attackData.rules{}.message as "Attack Type", events_fmt as "Total Events", severity as "Severity", ips_fmt as "Unique IPs", countries as "Countries", first_seen_time as "First Seen", last_seen_time as "Last Seen", duration_hours as "Duration (hrs)", targets as "Targets"

index=akami earliest=-24h@h latest=now
| rex field=attackData.rules{}.message "(?<attack_category>^[^(|]+)"
| eval attack_category=trim(attack_category)
| stats count as total_events
    dc(attackData.clientIP) as unique_ips
    dc(httpMessage.host) as unique_targets
    values(httpMessage.host) as targets
    dc(geo.country) as country_count
    min(_time) as first_seen
    max(_time) as last_seen
    by attack_category
| where isnotnull(attack_category)
| eval duration_hours=round((last_seen - first_seen)/3600, 1)
| eval events_fmt=tostring(total_events, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval first_time=strftime(first_seen, "%m-%d %H:%M")
| eval last_time=strftime(last_seen, "%m-%d %H:%M")
| eval severity=case(
    total_events >= 100000, "CRITICAL",
    total_events >= 50000, "HIGH",
    total_events >= 10000, "MEDIUM",
    1=1, "LOW")
| eval target_display=if(unique_targets > 3, mvindex(targets, 0, 2) + " (+" + tostring(unique_targets-3) + " more)", mvjoin(targets, ", "))
| table attack_category, events_fmt, severity, ips_fmt, country_count, first_time, last_time, duration_hours, target_display
| sort - total_events
| head 20
| rename attack_category as "Attack Type", events_fmt as "Events", severity as "Severity", ips_fmt as "Source IPs", country_count as "Countries", first_time as "First Seen", last_time as "Last Seen", duration_hours as "Duration (hrs)", target_display as "Targets"


index=akami earliest=-14d@d latest=now
| stats 
    count as total_events
    dc(attackData.rules{}.message) as attack_techniques
    values(httpMessage.host) as targets
    dc(httpMessage.host) as unique_targets
    values(geo.country) as country
    values(geo.asn) as asn
    min(_time) as first_seen
    max(_time) as last_seen
    by attackData.clientIP
| where total_events > 100
| eval duration_sec=(last_seen - first_seen)
| eval rps=round(total_events / duration_sec, 2)
| eval events_fmt=tostring(total_events, "commas")
| eval rps_fmt=tostring(rps, "commas")
| eval severity=case(
    rps >= 1000, "CRITICAL",
    rps >= 100, "HIGH",
    rps >= 10, "MEDIUM",
    1=1, "LOW")
| eval first_time=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_time=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_display=tostring(round(duration_sec/60, 0)) + "m"
| eval target_list=if(unique_targets > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(unique_targets - 3) + " more)", mvjoin(targets, ", "))
| sort - rps
| head 50
| table attackData.clientIP, rps_fmt, events_fmt, severity, attack_techniques, country, asn, first_time, last_time, duration_display, target_list
| rename 
    attackData.clientIP as "Source IP"
    rps_fmt as "RPS"
    events_fmt as "Total Requests"
    severity as "Severity"
    attack_techniques as "Techniques"
    country as "Country"
    asn as "ASN"
    first_time as "First Seen"
    last_time as "Last Seen"
    duration_display as "Duration"
    target_list as "Targets"


index=akami earliest=-24h@h latest=now
| rex field=attackData.rules{}.message "(?<attack_category>^[^(|]+)"
| eval attack_category=trim(attack_category)
| stats count as total_events, dc(attackData.clientIP) as unique_ips, dc(httpMessage.host) as unique_targets, values(httpMessage.host) as targets, dc(geo.country) as country_count, min(_time) as first_seen, max(_time) as last_seen by attack_category
| where isnotnull(attack_category) AND total_events > 0
| eval duration_hours=round((last_seen - first_seen) / 3600, 1)
| eval events_fmt=tostring(total_events, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval first_time=strftime(first_seen, "%m-%d %H:%M")
| eval last_time=strftime(last_seen, "%m-%d %H:%M")
| eval severity=case(total_events >= 100000, "CRITICAL", total_events >= 50000, "HIGH", total_events >= 10000, "MEDIUM", total_events >= 1000, "LOW", 1=1, "INFO")
| eval target_display=if(unique_targets > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(unique_targets - 3) + " more)", mvjoin(targets, ", "))
| sort limit=20 - total_events
| table attack_category, events_fmt, severity, ips_fmt, country_count, first_time, last_time, duration_hours, target_display
| rename attack_category as "Attack Type", events_fmt as "Events", severity as "Severity", ips_fmt as "Source IPs", country_count as "Countries", first_time as "First Seen", last_time as "Last Seen", duration_hours as "Duration (hrs)", target_display as "Targets"


index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type)
| stats 
    count as total_requests
    dc(attackData.clientIP) as unique_ips
    dc(attack_type) as attack_types_count
    values(attack_type) as attack_types
    dc(user_agent) as unique_user_agents
    values(user_agent) as user_agents
    values(httpMessage.host) as targets
    dc(httpMessage.host) as target_count
    values(geo.country) as countries
    dc(geo.country) as country_count
    min(_time) as first_seen
    max(_time) as last_seen
    by geo.asn
| where isnotnull(geo.asn) AND total_requests > 1000
| eval duration_sec=(last_seen - first_seen) + 1
| eval rps=round(total_requests / duration_sec, 0)
| eval requests_fmt=tostring(total_requests, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval rps_fmt=tostring(rps, "commas")
| eval severity=case(
    rps >= 1000000, "CRITICAL (1M+ RPS)",
    rps >= 100000, "HIGH (100K-1M RPS)",
    rps >= 10000, "MEDIUM (10K-100K RPS)",
    rps >= 1000, "LOW (1K-10K RPS)",
    1=1, "INFO")
| eval first_time=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_time=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min=tostring(round(duration_sec/60, 0)) + "m"
| eval attack_summary=if(attack_types_count > 5, mvjoin(mvindex(attack_types, 0, 4), " | ") + " (+" + tostring(attack_types_count - 5) + " more)", mvjoin(attack_types, " | "))
| eval ua_summary=if(unique_user_agents > 3, mvjoin(mvindex(user_agents, 0, 2), " | ") + " (+" + tostring(unique_user_agents - 3) + " more)", if(unique_user_agents > 0, mvjoin(user_agents, " | "), "N/A"))
| eval target_summary=if(target_count > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(target_count - 3) + " more)", mvjoin(targets, ", "))
| eval country_summary=if(country_count > 5, mvjoin(mvindex(countries, 0, 4), ", ") + " (+" + tostring(country_count - 5) + " more)", mvjoin(countries, ", "))
| sort - rps
| head 30
| table geo.asn, rps_fmt, severity, requests_fmt, ips_fmt, attack_types_count, attack_summary, ua_summary, country_summary, first_time, last_time, duration_min, target_summary
| rename 
    geo.asn as "ASN"
    rps_fmt as "RPS"
    severity as "Severity"
    requests_fmt as "Total Requests"
    ips_fmt as "Unique IPs"
    attack_types_count as "Attack Types"
    attack_summary as "Attack Methods"
    ua_summary as "User Agents"
    country_summary as "Countries"
    first_time as "First Seen"
    last_time as "Last Seen"
    duration_min as "Duration"
    target_summary as "Targets"



index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type)
| stats 
    count as total_requests
    dc(attackData.clientIP) as unique_ips
    dc(attack_type) as attack_types_count
    values(attack_type) as attack_types
    dc(user_agent) as unique_user_agents
    values(user_agent) as user_agents
    values(httpMessage.host) as targets
    dc(httpMessage.host) as target_count
    values(geo.country) as countries
    dc(geo.country) as country_count
    min(_time) as first_seen
    max(_time) as last_seen
    by geo.asn
| where isnotnull(geo.asn) AND total_requests > 1000
| eval duration_sec=(last_seen - first_seen) + 1
| eval rps=round(total_requests / duration_sec, 0)
| eval requests_fmt=tostring(total_requests, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval rps_fmt=tostring(rps, "commas")
| eval severity=case(
    rps >= 1000000, "CRITICAL (1M+ RPS)",
    rps >= 100000, "HIGH (100K-1M RPS)",
    rps >= 10000, "MEDIUM (10K-100K RPS)",
    rps >= 1000, "LOW (1K-10K RPS)",
    1=1, "INFO")
| eval first_time=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_time=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min=tostring(round(duration_sec/60, 0)) + "m"
| eval attack_summary=if(attack_types_count > 5, mvjoin(mvindex(attack_types, 0, 4), " | ") + " (+" + tostring(attack_types_count - 5) + " more)", mvjoin(attack_types, " | "))
| eval ua_summary=if(unique_user_agents > 3, mvjoin(mvindex(user_agents, 0, 2), " | ") + " (+" + tostring(unique_user_agents - 3) + " more)", if(unique_user_agents > 0, mvjoin(user_agents, " | "), "N/A"))
| eval target_summary=if(target_count > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(target_count - 3) + " more)", mvjoin(targets, ", "))
| eval country_summary=if(country_count > 5, mvjoin(mvindex(countries, 0, 4), ", ") + " (+" + tostring(country_count - 5) + " more)", mvjoin(countries, ", "))
| sort - rps
| head 30
| table geo.asn, rps_fmt, severity, requests_fmt, ips_fmt, attack_types_count, attack_summary, ua_summary, country_summary, first_time, last_time, duration_min, target_summary
| rename 
    geo.asn as "ASN"
    rps_fmt as "RPS"
    severity as "Severity"
    requests_fmt as "Total Requests"
    ips_fmt as "Unique IPs"
    attack_types_count as "Attack Types"
    attack_summary as "Attack Methods"
    ua_summary as "User Agents"
    country_summary as "Countries"
    first_time as "First Seen"
    last_time as "Last Seen"
    duration_min as "Duration"
    target_summary as "Targets"


index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type)
| stats 
    count as total_requests
    dc(attackData.clientIP) as unique_ips
    dc(attack_type) as attack_types_count
    values(attack_type) as attack_types
    values(httpMessage.host) as targets
    dc(httpMessage.host) as target_count
    values(geo.country) as countries
    min(_time) as first_seen
    max(_time) as last_seen
    by geo.asn
| eval duration_sec=(last_seen - first_seen) + 1
| eval rps=round(total_requests / duration_sec, 0)
| eval requests_fmt=tostring(total_requests, "commas")
| eval ips_fmt=tostring(unique_ips, "commas")
| eval rps_fmt=tostring(rps, "commas")
| eval severity=case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "INFO")
| eval first_time=strftime(first_seen, "%Y-%m-%d %H:%M")
| eval last_time=strftime(last_seen, "%Y-%m-%d %H:%M")
| eval attack_summary=mvjoin(mvindex(attack_types, 0, 3), " | ")
| eval target_summary=mvjoin(mvindex(targets, 0, 2), ", ")
| eval country_summary=mvjoin(countries, ", ")
| sort - rps
| head 50
| table geo.asn, rps_fmt, severity, requests_fmt, ips_fmt, attack_types_count, attack_summary, country_summary, first_time, last_time, target_summary
| rename 
    geo.asn as "ASN"
    rps_fmt as "RPS"
    severity as "Severity"
    requests_fmt as "Requests"
    ips_fmt as "IPs"
    attack_types_count as "Attack Types"
    attack_summary as "Methods"
    country_summary as "Countries"
    first_time as "First"
    last_time as "Last"
    target_summary as "Targets"



index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval user_agent=coalesce(user_agent, "N/A"), attack_type=coalesce(attack_type, "Unknown")
| stats 
    count AS total_requests,
    dc(attackData.clientIP) AS unique_ips,
    dc(httpMessage.host) AS unique_targets,
    values(httpMessage.host) AS targets,
    dc(geo.country) AS country_count,
    values(geo.country) AS countries,
    values(geo.asn) AS asn,
    min(_time) AS first_seen,
    max(_time) AS last_seen,
    dc(user_agent) AS unique_uas,
    values(user_agent) AS user_agents,
    values(attack_type) AS raw_attack_types
  BY geo.asn, user_agent
| eval attack_types=mvsort(mvdedup(raw_attack_types))
| eval attack_summary=mvjoin(attack_types, "\n")
| eval duration_sec=(last_seen - first_seen) + 1
| eval rps=round(total_requests / duration_sec, 2)
| eval severity=case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "NORMAL"
)
| eval first_seen_str=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min=round(duration_sec / 60, 1)
| eval requests_fmt=tostring(total_requests, "commas")
| eval rps_fmt=tostring(rps, "commas")
| eval ua_summary=if(unique_uas > 2, mvjoin(mvindex(user_agents, 0, 2), " | ") + " (+" + tostring(unique_uas - 2) + " more)", mvjoin(user_agents, " | "))
| eval target_summary=if(unique_targets > 3, mvjoin(mvindex(targets, 0, 2), ", ") + " (+" + tostring(unique_targets - 2) + " more)", mvjoin(targets, ", "))
| eval country_summary=if(country_count > 4, mvjoin(mvindex(countries, 0, 3), ", ") + " (+" + tostring(country_count - 3) + " more)", mvjoin(countries, ", "))
| sort - rps
| head 30
| table asn, rps_fmt, severity, requests_fmt, unique_ips, ua_summary, country_summary, first_seen_str, last_seen_str, duration_min, target_summary, attack_summary
| rename 
    asn as "ASN",
    rps_fmt as "RPS",
    severity as "Severity",
    requests_fmt as "Total Requests",
    unique_ips as "Unique IPs",
    ua_summary as "User Agents",
    country_summary as "Countries",
    first_seen_str as "First Seen",
    last_seen_str as "Last Seen",
    duration_min as "Duration (min)",
    target_summary as "Targets",
    attack_summary as "Attack Types"



index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval user_agent=coalesce(user_agent, "N/A"), attack_type=trim(attack_type)
| stats 
    count AS total_requests,
    dc(attackData.clientIP) AS unique_ips,
    dc(httpMessage.host) AS unique_targets,
    values(httpMessage.host) AS targets,
    dc(geo.country) AS country_count,
    values(geo.country) AS countries,
    values(geo.asn) AS asn,
    min(_time) AS first_seen,
    max(_time) AS last_seen,
    dc(user_agent) AS unique_uas,
    values(user_agent) AS user_agents,
    values(attack_type) AS attack_type_list
  BY geo.asn, user_agent
| eval duration_sec = (last_seen - first_seen) + 1
| eval rps = round(total_requests / duration_sec, 2)
| eval severity = case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "NORMAL"
)
| eval first_seen_str = strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str = strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min = round(duration_sec / 60, 1)
| eval requests_fmt = tostring(total_requests, "commas")
| eval rps_fmt = tostring(rps, "commas")
| eval ua_summary = if(unique_uas > 2, mvjoin(mvindex(user_agents, 0, 2), " | ") . " (+" . tostring(unique_uas - 2) . " more)", mvjoin(user_agents, " | "))
| eval target_summary = if(unique_targets > 3, mvjoin(mvindex(targets, 0, 2), ", ") . " (+" . tostring(unique_targets - 2) . " more)", mvjoin(targets, ", "))
| eval country_summary = if(country_count > 4, mvjoin(mvindex(countries, 0, 3), ", ") . " (+" . tostring(country_count - 3) . " more)", mvjoin(countries, ", "))
| eval attack_types = mvsort(mvdedup(attack_type_list))
| eval attack_summary = if(
    mvcount(attack_types) > 5,
    mvjoin(mvindex(attack_types, 0, 4), "; ") . "; (+" . tostring(mvcount(attack_types) - 5) . " more)",
    mvjoin(attack_types, "; ")
)
| sort - rps
| head 30
| table asn, rps_fmt, severity, requests_fmt, unique_ips, ua_summary, country_summary, first_seen_str, last_seen_str, duration_min, target_summary, attack_summary
| rename 
    asn as "ASN",
    rps_fmt as "RPS",
    severity as "Severity",
    requests_fmt as "Total Requests",
    unique_ips as "Unique IPs",
    ua_summary as "User Agents",
    country_summary as "Countries",
    first_seen_str as "First Seen",
    last_seen_str as "Last Seen",
    duration_min as "Duration (min)",
    target_summary as "Targets",
    attack_summary as "Attack Types"


index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type)
| eval norm_ua=lower(replace(user_agent, "\d+\.\d+(\.\d+)?", ""))  // Strip version numbers
| eval norm_ua=replace(norm_ua, "[^a-z0-9]+", "_")
| eval user_agent_group=substr(norm_ua, 0, 60)  // Truncate noise
| eval user_agent_group=coalesce(user_agent_group, "unknown_ua")
| eval attack_type_clean=coalesce(attack_type, "Unknown")
| stats 
    count AS total_requests,
    dc(attackData.clientIP) AS unique_ips,
    dc(httpMessage.host) AS unique_targets,
    values(httpMessage.host) AS targets,
    dc(geo.country) AS country_count,
    values(geo.country) AS countries,
    values(geo.asn) AS asn,
    min(_time) AS first_seen,
    max(_time) AS last_seen,
    dc(user_agent_group) AS ua_groups,
    values(user_agent) AS raw_uas,
    values(attack_type_clean) AS raw_attack_types
  BY geo.asn, user_agent_group, httpMessage.host
| eval duration_sec = (last_seen - first_seen) + 1
| eval rps = round(total_requests / duration_sec, 2)
| eval severity = case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "NORMAL"
)
| eval first_seen_str = strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str = strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min = round(duration_sec / 60, 1)
| eval requests_fmt = tostring(total_requests, "commas")
| eval rps_fmt = tostring(rps, "commas")
| eval ua_summary = mvjoin(mvsort(mvdedup(raw_uas)), " | ")
| eval target_summary = if(unique_targets > 3, mvjoin(mvindex(targets, 0, 2), ", ") . " (+" . tostring(unique_targets - 2) . " more)", mvjoin(targets, ", "))
| eval country_summary = if(country_count > 4, mvjoin(mvindex(countries, 0, 3), ", ") . " (+" . tostring(country_count - 3) . " more)", mvjoin(countries, ", "))
| eval attack_types = mvsort(mvdedup(raw_attack_types))
| eval attack_summary = if(
    mvcount(attack_types) > 5,
    mvjoin(mvindex(attack_types, 0, 4), "; ") . "; (+" . tostring(mvcount(attack_types) - 5) . " more)",
    mvjoin(attack_types, "; ")
)
| sort - rps
| head 30
| table asn, rps_fmt, severity, requests_fmt, unique_ips, ua_summary, country_summary, first_seen_str, last_seen_str, duration_min, target_summary, attack_summary
| rename 
    asn as "ASN",
    rps_fmt as "RPS",
    severity as "Severity",
    requests_fmt as "Total Requests",
    unique_ips as "Unique IPs",
    ua_summary as "User Agents",
    country_summary as "Countries",
    first_seen_str as "First Seen",
    last_seen_str as "Last Seen",
    duration_min as "Duration (min)",
    target_summary as "Targets",
    attack_summary as "Attack Types"



index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type), user_agent=coalesce(user_agent, "N/A")
| stats 
    count AS total_requests,
    dc(attackData.clientIP) AS unique_ips,
    dc(httpMessage.host) AS unique_targets,
    dc(geo.country) AS country_count,
    values(geo.country) AS countries,
    values(geo.asn) AS asn,
    min(_time) AS first_seen,
    max(_time) AS last_seen,
    dc(user_agent) AS unique_user_agents,
    values(attack_type) AS raw_attack_types
  BY geo.asn, user_agent
| eval duration_sec = (last_seen - first_seen) + 1
| eval rps = round(total_requests / duration_sec, 2)
| eval severity = case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "NORMAL"
)
| eval first_seen_str = strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str = strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min = round(duration_sec / 60, 1)
| eval requests_fmt = tostring(total_requests, "commas")
| eval rps_fmt = tostring(rps, "commas")
| eval country_summary = if(country_count > 4, mvjoin(mvindex(countries, 0, 3), ", ") . " (+" . tostring(country_count - 3) . " more)", mvjoin(countries, ", "))
| eval attack_types = mvsort(mvdedup(raw_attack_types))
| eval attack_summary = if(
    mvcount(attack_types) > 5,
    mvjoin(mvindex(attack_types, 0, 4), "; ") . "; (+" . tostring(mvcount(attack_types) - 5) . " more)",
    mvjoin(attack_types, "; ")
)
| sort - rps
| head 30
| table asn, rps_fmt, severity, requests_fmt, unique_ips, unique_user_agents, country_summary, first_seen_str, last_seen_str, duration_min, unique_targets, attack_summary
| rename 
    asn as "ASN",
    rps_fmt as "RPS",
    severity as "Severity",
    requests_fmt as "Total Requests",
    unique_ips as "Unique IPs",
    unique_user_agents as "Unique UAs",
    country_summary as "Countries",
    first_seen_str as "First Seen",
    last_seen_str as "Last Seen",
    duration_min as "Duration (min)",
    unique_targets as "Unique Targets",
    attack_summary as "Attack Types"


index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type), user_agent=coalesce(user_agent, "N/A")
| eval ts=_time
| stats 
    count AS event_count,
    dc(attackData.clientIP) AS unique_ips,
    dc(httpMessage.host) AS unique_targets,
    dc(user_agent) AS unique_user_agents,
    dc(geo.country) AS country_count,
    values(httpMessage.host) AS targets,
    values(geo.country) AS countries,
    values(attack_type) AS attack_types,
    values(attackData.clientIP) AS ips,
    sum(httpMessage.bytes) AS bytes_total,
    min(ts) AS first_seen,
    max(ts) AS last_seen
  BY geo.asn, user_agent, _time
| sort 0 geo.asn, user_agent, _time
| streamstats current=f window=1 last(_time) AS prev_time BY geo.asn, user_agent
| eval time_gap = _time - prev_time
| eval new_attack = if(isnull(prev_time) OR time_gap > 300, 1, 0)
| streamstats sum(new_attack) AS attack_id BY geo.asn, user_agent
| eventstats 
    min(first_seen) AS attack_start,
    max(last_seen) AS attack_end,
    sum(event_count) AS total_requests,
    dc(unique_ips) AS total_unique_ips,
    dc(unique_targets) AS total_unique_targets,
    dc(unique_user_agents) AS total_unique_uas,
    values(countries) AS all_countries,
    values(attack_types) AS all_attack_types
  BY geo.asn, user_agent, attack_id
| where _time = attack_start
| eval duration_sec = attack_end - attack_start + 1
| eval rps = round(total_requests / duration_sec, 2)
| eval severity = case(
    rps >= 1000000, "CRITICAL",
    rps >= 100000, "HIGH",
    rps >= 10000, "MEDIUM",
    rps >= 1000, "LOW",
    1=1, "NORMAL"
)
| eval first_seen_str = strftime(attack_start, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str = strftime(attack_end, "%Y-%m-%d %H:%M UTC")
| eval duration_min = round(duration_sec / 60, 1)
| eval requests_fmt = tostring(total_requests, "commas")
| eval rps_fmt = tostring(rps, "commas")
| eval country_summary = if(mvcount(all_countries) > 4, mvjoin(mvindex(all_countries, 0, 3), ", ") . " (+" . tostring(mvcount(all_countries) - 3) . " more)", mvjoin(all_countries, ", "))
| eval attack_type_summary = mvsort(mvdedup(all_attack_types))
| eval attack_summary = if(
    mvcount(attack_type_summary) > 5,
    mvjoin(mvindex(attack_type_summary, 0, 4), "; ") . "; (+" . tostring(mvcount(attack_type_summary) - 5) . " more)",
    mvjoin(attack_type_summary, "; ")
)
| table geo.asn, user_agent, rps_fmt, severity, requests_fmt, total_unique_ips, total_unique_uas, country_summary, first_seen_str, last_seen_str, duration_min, total_unique_targets, attack_summary
| rename 
    geo.asn AS "ASN",
    user_agent AS "User Agent",
    rps_fmt AS "RPS",
    severity AS "Severity",
    requests_fmt AS "Total Requests",
    total_unique_ips AS "Unique IPs",
    total_unique_uas AS "Unique UAs",
    country_summary AS "Countries",
    first_seen_str AS "First Seen",
    last_seen_str AS "Last Seen",
    duration_min AS "Duration (min)",
    total_unique_targets AS "Unique Targets",
    attack_summary AS "Attack Types"


index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval user_agent=coalesce(user_agent,"N/A"), attack_type=trim(attack_type)
| bin _time span=1m
| stats count as bucket_requests
        dc(attackData.clientIP) as bucket_unique_ips
        dc(httpMessage.host) as bucket_unique_targets
        dc(user_agent) as bucket_unique_uas
        values(geo.country) as bucket_countries
        values(attack_type) as bucket_attack_types
        min(_time) as bucket_start
        max(_time) as bucket_end
    by geo.asn, _time
| eval bucket_rps=round(bucket_requests/60,2)
| where bucket_rps > 0
| sort 0 geo.asn _time
| streamstats current=f window=1 last(_time) as prev_time by geo.asn
| eval gap=_time - prev_time
| eval new_attack=if(isnull(prev_time) OR gap > 600,1,0)
| streamstats sum(new_attack) as attack_id by geo.asn
| stats sum(bucket_requests) as total_requests
        max(bucket_rps) as peak_rps
        avg(bucket_rps) as avg_rps
        max(bucket_unique_ips) as unique_ips
        max(bucket_unique_targets) as unique_targets
        max(bucket_unique_uas) as unique_uas
        values(bucket_countries) as countries
        values(bucket_attack_types) as all_attack_types
        min(bucket_start) as first_seen
        max(bucket_end) as last_seen
    by geo.asn, attack_id
| eval duration_sec=last_seen - first_seen + 60
| eval rps=round(total_requests/duration_sec,2)
| eval severity=case(
        rps >= 1000000,"CRITICAL",
        rps >= 100000,"HIGH",
        rps >= 10000,"MEDIUM",
        rps >= 1000,"LOW",
        1=1,"NORMAL"
    )
| eval first_seen_str=strftime(first_seen,"%Y-%m-%d %H:%M UTC")
| eval last_seen_str=strftime(last_seen,"%Y-%m-%d %H:%M UTC")
| eval duration_min=round(duration_sec/60,1)
| eval requests_fmt=tostring(total_requests,"commas")
| eval rps_fmt=tostring(rps,"commas")
| eval country_summary=if(mvcount(countries)>4,mvjoin(mvindex(countries,0,3),", ") . " (+" . tostring(mvcount(countries)-3) . " more)",mvjoin(countries,", "))
| eval attack_type_list=mvsort(mvdedup(all_attack_types))
| eval attack_summary=if(mvcount(attack_type_list)>5,mvjoin(mvindex(attack_type_list,0,4),"; ") . "; (+" . tostring(mvcount(attack_type_list)-5) . " more)",mvjoin(attack_type_list,"; "))
| where rps >= 100
| sort - rps
| table geo.asn, rps_fmt, severity, requests_fmt, unique_ips, unique_uas, country_summary, first_seen_str, last_seen_str, duration_min, unique_targets, attack_summary
| rename geo.asn as "ASN",
        rps_fmt as "RPS",
        severity as "Severity",
        requests_fmt as "Total Requests",
        unique_ips as "Unique IPs",
        unique_uas as "Unique UAs",
        country_summary as "Countries",
        first_seen_str as "First Seen",
        last_seen_str as "Last Seen",
        duration_min as "Duration (min)",
        unique_targets as "Unique Targets",
        attack_summary as "Attack Types"




index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval user_agent=coalesce(user_agent,"N/A"), attack_type=trim(attack_type)
| bin _time span=1m
| stats count as bucket_requests
        dc(attackData.clientIP) as bucket_unique_ips
        dc(httpMessage.host) as bucket_unique_targets
        values(geo.country) as bucket_countries
        values(attack_type) as bucket_attack_types
    by geo.asn, _time
| eval bucket_rps=round(bucket_requests/60,2)
| stats sum(bucket_requests) as total_requests
        max(bucket_rps) as peak_rps
        avg(bucket_rps) as avg_rps
        max(bucket_unique_ips) as unique_ips
        max(bucket_unique_targets) as unique_targets
        values(bucket_countries) as countries
        values(bucket_attack_types) as all_attack_types
        min(_time) as first_seen
        max(_time) as last_seen
    by geo.asn
| eval duration_sec=last_seen - first_seen + 60
| eval severity=case(
        peak_rps >= 100000, "CRITICAL",
        peak_rps >= 10000, "HIGH",
        peak_rps >= 1000, "MEDIUM",
        peak_rps >= 100, "LOW",
        1=1, "NORMAL"
    )
| eval first_seen_str=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min=round(duration_sec/60,1)
| eval requests_fmt=tostring(total_requests, "commas")
| eval peak_rps_fmt=tostring(peak_rps, "commas")
| eval country_summary=if(
        mvcount(countries)>4,
        mvjoin(mvindex(countries,0,3), ", ") . " (+" . tostring(mvcount(countries)-3) . " more)",
        mvjoin(countries, ", ")
    )
| eval attack_type_list=mvsort(mvdedup(all_attack_types))
| eval attack_summary=if(
        mvcount(attack_type_list)>5,
        mvjoin(mvindex(attack_type_list,0,4), "; ") . "; (+" . tostring(mvcount(attack_type_list)-5) . " more)",
        mvjoin(attack_type_list, "; ")
    )
| where peak_rps >= 100
| sort - peak_rps
| table geo.asn, peak_rps_fmt, severity, requests_fmt, unique_ips, country_summary, first_seen_str, last_seen_str, duration_min, unique_targets, attack_summary
| rename 
        geo.asn as "ASN",
        peak_rps_fmt as "Peak RPS",
        severity as "Severity",
        requests_fmt as "Total Requests",
        unique_ips as "Unique IPs",
        country_summary as "Countries",
        first_seen_str as "First Seen",
        last_seen_str as "Last Seen",
        duration_min as "Duration (min)",
        unique_targets as "Unique Targets",
        attack_summary as "Attack Types"



index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval user_agent=coalesce(user_agent,"N/A"), attack_type=trim(attack_type)
| bin _time span=1m
| stats count as bucket_requests
        dc(attackData.clientIP) as bucket_unique_ips
        dc(httpMessage.host) as bucket_unique_targets
        values(geo.country) as bucket_countries
        values(attack_type) as bucket_attack_types
    by geo.asn, _time
| eval bucket_rps=round(bucket_requests/60,2)
| stats sum(bucket_requests) as total_requests
        max(bucket_rps) as peak_rps
        avg(bucket_rps) as avg_rps
        max(bucket_unique_ips) as unique_ips
        max(bucket_unique_targets) as unique_targets
        values(bucket_countries) as countries
        values(bucket_attack_types) as all_attack_types
        min(_time) as first_seen
        max(_time) as last_seen
    by geo.asn
| eval duration_sec=last_seen - first_seen + 60
| eval severity=case(
        peak_rps >= 100000, "CRITICAL",
        peak_rps >= 10000, "HIGH",
        peak_rps >= 1000, "MEDIUM",
        peak_rps >= 100, "LOW",
        1=1, "NORMAL"
    )
| eval first_seen_str=strftime(first_seen, "%Y-%m-%d %H:%M UTC")
| eval last_seen_str=strftime(last_seen, "%Y-%m-%d %H:%M UTC")
| eval duration_min=round(duration_sec/60,1)
| eval requests_fmt=tostring(total_requests, "commas")
| eval peak_rps_fmt=tostring(peak_rps, "commas")
| eval country_summary=if(
        mvcount(countries)>4,
        mvjoin(mvindex(countries,0,3), ", ") . " (+" . tostring(mvcount(countries)-3) . " more)",
        mvjoin(countries, ", ")
    )
| eval attack_type_list=mvsort(mvdedup(all_attack_types))
| eval attack_summary=if(
        mvcount(attack_type_list)>5,
        mvjoin(mvindex(attack_type_list,0,4), "; ") . "; (+" . tostring(mvcount(attack_type_list)-5) . " more)",
        mvjoin(attack_type_list, "; ")
    )
| where peak_rps >= 100
| sort - peak_rps
| table geo.asn, peak_rps_fmt, severity, requests_fmt, unique_ips, country_summary, first_seen_str, last_seen_str, duration_min, unique_targets, attack_summary
| rename 
        geo.asn as "ASN",
        peak_rps_fmt as "Peak RPS",
        severity as "Severity",
        requests_fmt as "Total Requests",
        unique_ips as "Unique IPs",
        country_summary as "Countries",
        first_seen_str as "First Seen",
        last_seen_str as "Last Seen",
        duration_min as "Duration (min)",
        unique_targets as "Unique Targets",
        attack_summary as "Attack Types"




index=akami earliest=-14d@d latest=now
| rex field=httpMessage.requestHeaders "User-Agent:\s+(?<user_agent>[^\r\n]+)"
| rex field=attackData.rules{}.message "(?<attack_type>^[^(|]+)"
| eval attack_type=trim(attack_type)
| bin _time span=30s
| stats count as bucket_requests
        dc(attackData.clientIP) as bucket_unique_ips
        values(httpMessage.host) as bucket_hosts
        values(geo.country) as bucket_countries
        values(attack_type) as bucket_attack_types
    by geo.asn, _time
| eval bucket_rps=round(bucket_requests/30,2)
| where bucket_rps >= 100
| sort 0 geo.asn, _time
| streamstats current=f window=1 last(_time) as prev_time by geo.asn
| eval gap=_time - prev_time
| eval new_attack=if(isnull(prev_time) OR gap > 300, 1, 0)
| streamstats sum(new_attack) as attack_id by geo.asn
| stats sum(bucket_requests) as total_requests
        max(bucket_rps) as peak_rps
        avg(bucket_rps) as avg_rps
        max(bucket_unique_ips) as unique_ips
        values(bucket_hosts) as hosts
        values(bucket_countries) as countries
        values(bucket_attack_types) as all_attack_types
        min(_time) as attack_start
        max(_time) as attack_end
    by geo.asn, attack_id
| eval duration_sec = attack_end - attack_start + 30
| eval avg_rps_session = round(total_requests / duration_sec, 2)
| eval severity = case(
        peak_rps >= 100000, "CRITICAL",
        peak_rps >= 10000, "HIGH",
        peak_rps >= 1000, "MEDIUM",
        peak_rps >= 100, "LOW",
        1=1, "NORMAL"
    )
| eval attack_start_str = strftime(attack_start, "%Y-%m-%d %H:%M UTC")
| eval attack_end_str = strftime(attack_end, "%Y-%m-%d %H:%M UTC")
| eval duration_min = round(duration_sec/60, 1)
| eval total_requests_fmt = tostring(total_requests, "commas")
| eval peak_rps_fmt = tostring(peak_rps, "commas")
| eval avg_rps_fmt = tostring(avg_rps_session, "commas")
| eval countries_summary = if(
        mvcount(countries) > 4,
        mvjoin(mvindex(countries, 0, 3), ", ") + " (+" + tostring(mvcount(countries) - 4, "commas") + " more)",
        mvjoin(countries, ", ")
    )
| eval host_summary = if(
        mvcount(hosts) > 2,
        mvindex(hosts, 0) + ", " + mvindex(hosts, 1) + " (+" + tostring(mvcount(hosts) - 2, "commas") + " more)",
        mvjoin(hosts, ", ")
    )
| eval attack_type_list = mvsort(mvdedup(all_attack_types))
| eval attack_summary = if(
        mvcount(attack_type_list) > 5,
        mvjoin(mvindex(attack_type_list, 0, 4), "; ") + "; (+" + tostring(mvcount(attack_type_list) - 5, "commas") + " more)",
        mvjoin(attack_type_list, "; ")
    )
| sort - peak_rps
| table geo.asn, attack_start_str, attack_end_str, duration_min, peak_rps_fmt, avg_rps_fmt, severity, total_requests_fmt, unique_ips, countries_summary, host_summary, attack_summary
| rename 
        geo.asn as "ASN",
        attack_start_str as "Attack Start",
        attack_end_str as "Attack End",
        duration_min as "Duration (min)",
        peak_rps_fmt as "Peak RPS (30s bucket)",
        avg_rps_fmt as "Avg RPS (session)",
        severity as "Severity",
        total_requests_fmt as "Total Requests",
        unique_ips as "Unique IPs",
        countries_summary as "Countries",
        host_summary as "Primary Targets",
        attack_summary as "Attack Types"
